(function(){function e(){}function t(e,t){for(var n=e.length;n--;)if(e[n].listener===t)return n;return-1}function n(e){return function(){return this[e].apply(this,arguments)}}var i=e.prototype;i.getListeners=function(e){var t,n,i=this._getEvents();if("object"==typeof e){t={};for(n in i)i.hasOwnProperty(n)&&e.test(n)&&(t[n]=i[n])}else t=i[e]||(i[e]=[]);return t},i.flattenListeners=function(e){var t,n=[];for(t=0;e.length>t;t+=1)n.push(e[t].listener);return n},i.getListenersAsObject=function(e){var t,n=this.getListeners(e);return n instanceof Array&&(t={},t[e]=n),t||n},i.addListener=function(e,n){var i,r=this.getListenersAsObject(e),o="object"==typeof n;for(i in r)r.hasOwnProperty(i)&&-1===t(r[i],n)&&r[i].push(o?n:{listener:n,once:!1});return this},i.on=n("addListener"),i.addOnceListener=function(e,t){return this.addListener(e,{listener:t,once:!0})},i.once=n("addOnceListener"),i.defineEvent=function(e){return this.getListeners(e),this},i.defineEvents=function(e){for(var t=0;e.length>t;t+=1)this.defineEvent(e[t]);return this},i.removeListener=function(e,n){var i,r,o=this.getListenersAsObject(e);for(r in o)o.hasOwnProperty(r)&&(i=t(o[r],n),-1!==i&&o[r].splice(i,1));return this},i.off=n("removeListener"),i.addListeners=function(e,t){return this.manipulateListeners(!1,e,t)},i.removeListeners=function(e,t){return this.manipulateListeners(!0,e,t)},i.manipulateListeners=function(e,t,n){var i,r,o=e?this.removeListener:this.addListener,s=e?this.removeListeners:this.addListeners;if("object"!=typeof t||t instanceof RegExp)for(i=n.length;i--;)o.call(this,t,n[i]);else for(i in t)t.hasOwnProperty(i)&&(r=t[i])&&("function"==typeof r?o.call(this,i,r):s.call(this,i,r));return this},i.removeEvent=function(e){var t,n=typeof e,i=this._getEvents();if("string"===n)delete i[e];else if("object"===n)for(t in i)i.hasOwnProperty(t)&&e.test(t)&&delete i[t];else delete this._events;return this},i.removeAllListeners=n("removeEvent"),i.emitEvent=function(e,t){var n,i,r,o,s=this.getListenersAsObject(e);for(r in s)if(s.hasOwnProperty(r))for(i=s[r].length;i--;)n=s[r][i],n.once===!0&&this.removeListener(e,n.listener),o=n.listener.apply(this,t||[]),o===this._getOnceReturnValue()&&this.removeListener(e,n.listener);return this},i.trigger=n("emitEvent"),i.emit=function(e){var t=Array.prototype.slice.call(arguments,1);return this.emitEvent(e,t)},i.setOnceReturnValue=function(e){return this._onceReturnValue=e,this},i._getOnceReturnValue=function(){return this.hasOwnProperty("_onceReturnValue")?this._onceReturnValue:!0},i._getEvents=function(){return this._events||(this._events={})},"function"==typeof define&&define.amd?define("eventEmitter/EventEmitter",[],function(){return e}):"object"==typeof module&&module.exports?module.exports=e:this.EventEmitter=e}).call(this),function(e){var t=document.documentElement,n=function(){};t.addEventListener?n=function(e,t,n){e.addEventListener(t,n,!1)}:t.attachEvent&&(n=function(t,n,i){t[n+i]=i.handleEvent?function(){var t=e.event;t.target=t.target||t.srcElement,i.handleEvent.call(i,t)}:function(){var n=e.event;n.target=n.target||n.srcElement,i.call(t,n)},t.attachEvent("on"+n,t[n+i])});var i=function(){};t.removeEventListener?i=function(e,t,n){e.removeEventListener(t,n,!1)}:t.detachEvent&&(i=function(e,t,n){e.detachEvent("on"+t,e[t+n]);try{delete e[t+n]}catch(i){e[t+n]=void 0}});var r={bind:n,unbind:i};"function"==typeof define&&define.amd?define("eventie/eventie",r):e.eventie=r}(this),function(e){function t(e,t){for(var n in t)e[n]=t[n];return e}function n(e){return"[object Array]"===c.call(e)}function i(e){var t=[];if(n(e))t=e;else if("number"==typeof e.length)for(var i=0,r=e.length;r>i;i++)t.push(e[i]);else t.push(e);return t}function r(e,n){function r(e,n,s){if(!(this instanceof r))return new r(e,n);"string"==typeof e&&(e=document.querySelectorAll(e)),this.elements=i(e),this.options=t({},this.options),"function"==typeof n?s=n:t(this.options,n),s&&this.on("always",s),this.getImages(),o&&(this.jqDeferred=new o.Deferred);var a=this;setTimeout(function(){a.check()})}function c(e){this.img=e}r.prototype=new e,r.prototype.options={},r.prototype.getImages=function(){this.images=[];for(var e=0,t=this.elements.length;t>e;e++){var n=this.elements[e];"IMG"===n.nodeName&&this.addImage(n);for(var i=n.querySelectorAll("img"),r=0,o=i.length;o>r;r++){var s=i[r];this.addImage(s)}}},r.prototype.addImage=function(e){var t=new c(e);this.images.push(t)},r.prototype.check=function(){function e(e,r){return t.options.debug&&a&&s.log("confirm",e,r),t.progress(e),n++,n===i&&t.complete(),!0}var t=this,n=0,i=this.images.length;if(this.hasAnyBroken=!1,!i)return this.complete(),void 0;for(var r=0;i>r;r++){var o=this.images[r];o.on("confirm",e),o.check()}},r.prototype.progress=function(e){this.hasAnyBroken=this.hasAnyBroken||!e.isLoaded;var t=this;setTimeout(function(){t.emit("progress",t,e),t.jqDeferred&&t.jqDeferred.notify(t,e)})},r.prototype.complete=function(){var e=this.hasAnyBroken?"fail":"done";this.isComplete=!0;var t=this;setTimeout(function(){if(t.emit(e,t),t.emit("always",t),t.jqDeferred){var n=t.hasAnyBroken?"reject":"resolve";t.jqDeferred[n](t)}})},o&&(o.fn.imagesLoaded=function(e,t){var n=new r(this,e,t);return n.jqDeferred.promise(o(this))});var f={};return c.prototype=new e,c.prototype.check=function(){var e=f[this.img.src];if(e)return this.useCached(e),void 0;if(f[this.img.src]=this,this.img.complete&&void 0!==this.img.naturalWidth)return this.confirm(0!==this.img.naturalWidth,"naturalWidth"),void 0;var t=this.proxyImage=new Image;n.bind(t,"load",this),n.bind(t,"error",this),t.src=this.img.src},c.prototype.useCached=function(e){if(e.isConfirmed)this.confirm(e.isLoaded,"cached was confirmed");else{var t=this;e.on("confirm",function(e){return t.confirm(e.isLoaded,"cache emitted confirmed"),!0})}},c.prototype.confirm=function(e,t){this.isConfirmed=!0,this.isLoaded=e,this.emit("confirm",this,t)},c.prototype.handleEvent=function(e){var t="on"+e.type;this[t]&&this[t](e)},c.prototype.onload=function(){this.confirm(!0,"onload"),this.unbindProxyEvents()},c.prototype.onerror=function(){this.confirm(!1,"onerror"),this.unbindProxyEvents()},c.prototype.unbindProxyEvents=function(){n.unbind(this.proxyImage,"load",this),n.unbind(this.proxyImage,"error",this)},r}var o=e.jQuery,s=e.console,a=s!==void 0,c=Object.prototype.toString;"function"==typeof define&&define.amd?define(["eventEmitter/EventEmitter","eventie/eventie"],r):e.imagesLoaded=r(e.EventEmitter,e.eventie)}(window);(function($,window,document,undefined){"use strict";var $event=$.event,$special,dummy={_:0},frame=0,wasResized,animRunning;$special=$event.special.throttledresize={setup:function(){$(this).on("resize",$special.handler)},teardown:function(){$(this).off("resize",$special.handler)},handler:function(event,execAsap){var context=this,args=arguments;wasResized=true;if(!animRunning){setInterval(function(){frame++;if(frame>$special.threshold&&wasResized||execAsap){event.type="throttledresize";$event.dispatch.apply(context,args);wasResized=false;frame=0}if(frame>9){$(dummy).stop();animRunning=false;frame=0}},30);animRunning=true}},threshold:0}})(jQuery,window,document);(function(t,m,e){var l=e(t),q=e(m),a=e.fancybox=function(){a.open.apply(this,arguments)},r=!1,s="undefined"!==typeof m.createTouch;e.extend(a,{version:"2.0.5",defaults:{padding:15,margin:20,width:800,height:600,minWidth:100,minHeight:100,maxWidth:9999,maxHeight:9999,autoSize:!0,autoResize:!s,autoCenter:!s,fitToView:!0,aspectRatio:!1,topRatio:.5,fixed:!(e.browser.msie&&6>=e.browser.version)&&!s,scrolling:"auto",wrapCSS:"fancybox-default",arrows:!0,closeBtn:!0,closeClick:!1,nextClick:!1,mouseWheel:!0,autoPlay:!1,playSpeed:3e3,preload:3,modal:!1,loop:!0,ajax:{dataType:"html",headers:{"X-fancyBox":!0}},keys:{next:[13,32,34,39,40],prev:[8,33,37,38],close:[27]},tpl:{wrap:'<div class="fancybox-wrap"><div class="fancybox-outer"><div class="fancybox-inner"></div></div></div>',image:'<img class="fancybox-image" src="{href}" alt="" />',iframe:'<iframe class="fancybox-iframe" name="fancybox-frame{rnd}" frameborder="0" hspace="0"'+(e.browser.msie?' allowtransparency="true"':"")+"></iframe>",swf:'<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" width="100%" height="100%"><param name="wmode" value="transparent" /><param name="allowfullscreen" value="true" /><param name="allowscriptaccess" value="always" /><param name="movie" value="{href}" /><embed src="{href}" type="application/x-shockwave-flash" allowfullscreen="true" allowscriptaccess="always" width="100%" height="100%" wmode="transparent"></embed></object>',error:'<p class="fancybox-error">The requested content cannot be loaded.<br/>Please try again later.</p>',closeBtn:'<div title="Close" class="fancybox-item fancybox-close"></div>',next:'<a title="Next" class="fancybox-nav fancybox-next"><span></span></a>',prev:'<a title="Previous" class="fancybox-nav fancybox-prev"><span></span></a>'},openEffect:"fade",openSpeed:250,openEasing:"swing",openOpacity:!0,openMethod:"zoomIn",closeEffect:"fade",closeSpeed:250,closeEasing:"swing",closeOpacity:!0,closeMethod:"zoomOut",nextEffect:"elastic",nextSpeed:300,nextEasing:"swing",nextMethod:"changeIn",prevEffect:"elastic",prevSpeed:300,prevEasing:"swing",prevMethod:"changeOut",helpers:{overlay:{speedIn:0,speedOut:300,opacity:.8,css:{cursor:"pointer"},closeClick:!0},title:{type:"float"}}},group:{},opts:{},coming:null,current:null,isOpen:!1,isOpened:!1,wrap:null,outer:null,inner:null,player:{timer:null,isActive:!1},ajaxLoad:null,imgPreload:null,transitions:{},helpers:{},open:function(b,c){a.close(!0);b&&!e.isArray(b)&&(b=b instanceof e?e(b).get():[b]);a.isActive=!0;a.opts=e.extend(!0,{},a.defaults,c);e.isPlainObject(c)&&"undefined"!==typeof c.keys&&(a.opts.keys=c.keys?e.extend({},a.defaults.keys,c.keys):!1);a.group=b;a._start(a.opts.index||0)},cancel:function(){a.coming&&!1===a.trigger("onCancel")||(a.coming=null,a.hideLoading(),a.ajaxLoad&&a.ajaxLoad.abort(),a.ajaxLoad=null,a.imgPreload&&(a.imgPreload.onload=a.imgPreload.onabort=a.imgPreload.onerror=null))},close:function(b){a.cancel();a.current&&!1!==a.trigger("beforeClose")&&(a.unbindEvents(),!a.isOpen||b&&!0===b[0]?(e(".fancybox-wrap").stop().trigger("onReset").remove(),a._afterZoomOut()):(a.isOpen=a.isOpened=!1,e(".fancybox-item, .fancybox-nav").remove(),a.wrap.stop(!0).removeClass("fancybox-opened"),a.inner.css("overflow","hidden"),a.transitions[a.current.closeMethod]()))},play:function(b){var c=function(){clearTimeout(a.player.timer)},d=function(){c();a.current&&a.player.isActive&&(a.player.timer=setTimeout(a.next,a.current.playSpeed))},g=function(){c();e("body").unbind(".player");a.player.isActive=!1;a.trigger("onPlayEnd")};if(a.player.isActive||b&&!1===b[0])g();else if(a.current&&(a.current.loop||a.current.index<a.group.length-1))a.player.isActive=!0,e("body").bind({"afterShow.player onUpdate.player":d,"onCancel.player beforeClose.player":g,"beforeLoad.player":c}),d(),a.trigger("onPlayStart")},next:function(){a.current&&a.jumpto(a.current.index+1)},prev:function(){a.current&&a.jumpto(a.current.index-1)},jumpto:function(b){a.current&&(b=parseInt(b,10),1<a.group.length&&a.current.loop&&(b>=a.group.length?b=0:0>b&&(b=a.group.length-1)),"undefined"!==typeof a.group[b]&&(a.cancel(),a._start(b)))},reposition:function(b){a.isOpen&&a.wrap.css(a._getPosition(b))},update:function(b){a.isOpen&&(r||setTimeout(function(){var c=a.current;if(r&&(r=!1,c)){if(c.autoResize||b&&"orientationchange"===b.type)c.autoSize&&(a.inner.height("auto"),c.height=a.inner.height()),a._setDimension(),c.canGrow&&a.inner.height("auto");c.autoCenter&&a.reposition();a.trigger("onUpdate")}},100),r=!0)},toggle:function(){a.isOpen&&(a.current.fitToView=!a.current.fitToView,a.update())},hideLoading:function(){e("#fancybox-loading").remove()},showLoading:function(){a.hideLoading();e('<div id="fancybox-loading"><div></div></div>').click(a.cancel).appendTo("body")},getViewport:function(){return{x:l.scrollLeft(),y:l.scrollTop(),w:l.width(),h:l.height()}},unbindEvents:function(){a.wrap&&a.wrap.unbind(".fb");q.unbind(".fb");l.unbind(".fb")},bindEvents:function(){var b=a.current,c=b.keys;b&&(l.bind("resize.fb, orientationchange.fb",a.update),c&&q.bind("keydown.fb",function(b){var g;!b.ctrlKey&&!b.altKey&&!b.shiftKey&&!b.metaKey&&0>e.inArray(b.target.tagName.toLowerCase(),["input","textarea","select","button"])&&(g=b.keyCode,-1<e.inArray(g,c.close)?(a.close(),b.preventDefault()):-1<e.inArray(g,c.next)?(a.next(),b.preventDefault()):-1<e.inArray(g,c.prev)&&(a.prev(),b.preventDefault()))}),e.fn.mousewheel&&b.mouseWheel&&1<a.group.length&&a.wrap.bind("mousewheel.fb",function(b,c){var f=e(b.target).get(0);if(0===f.clientHeight||f.scrollHeight===f.clientHeight&&f.scrollWidth===f.clientWidth)b.preventDefault(),a[0<c?"prev":"next"]()}))},trigger:function(b){var c,d=a[-1<e.inArray(b,["onCancel","beforeLoad","afterLoad"])?"coming":"current"];if(d){e.isFunction(d[b])&&(c=d[b].apply(d,Array.prototype.slice.call(arguments,1)));if(!1===c)return!1;d.helpers&&e.each(d.helpers,function(c,f){if(f&&"undefined"!==typeof a.helpers[c]&&e.isFunction(a.helpers[c][b]))a.helpers[c][b](f,d)});e.event.trigger(b+".fb")}},isImage:function(a){return a&&a.match(/\.(jpg|gif|png|bmp|jpeg)(.*)?$/i)},isSWF:function(a){return a&&a.match(/\.(swf)(.*)?$/i)},_start:function(b){var c={},d=a.group[b]||null,g,f,k;if(d&&(d.nodeType||d instanceof e))g=!0,e.metadata&&(c=e(d).metadata());c=e.extend(!0,{},a.opts,{index:b,element:d},e.isPlainObject(d)?d:c);e.each(["href","title","content","type"],function(b,f){c[f]=a.opts[f]||g&&e(d).attr(f)||c[f]||null});"number"===typeof c.margin&&(c.margin=[c.margin,c.margin,c.margin,c.margin]);c.modal&&e.extend(!0,c,{closeBtn:!1,closeClick:!1,nextClick:!1,arrows:!1,mouseWheel:!1,keys:null,helpers:{overlay:{css:{cursor:"auto"},closeClick:!1}}});a.coming=c;if(!1===a.trigger("beforeLoad"))a.coming=null;else{f=c.type;b=c.href||d;f||(g&&(k=e(d).data("fancybox-type"),!k&&d.className&&(f=(k=d.className.match(/fancybox\.(\w+)/))?k[1]:null)),!f&&"string"===e.type(b)&&(a.isImage(b)?f="image":a.isSWF(b)?f="swf":b.match(/^#/)&&(f="inline")),f||(f=g?"inline":"html"),c.type=f);if("inline"===f||"html"===f){if(c.content||(c.content="inline"===f?e("string"===e.type(b)?b.replace(/.*(?=#[^\s]+$)/,""):b):d),!c.content||!c.content.length)f=null}else b||(f=null);c.group=a.group;c.isDom=g;c.href=b;"image"===f?a._loadImage():"ajax"===f?a._loadAjax():f?a._afterLoad():a._error("type")}},_error:function(b){a.hideLoading();e.extend(a.coming,{type:"html",autoSize:!0,minHeight:0,hasError:b,content:a.coming.tpl.error});a._afterLoad()},_loadImage:function(){a.imgPreload=new Image;a.imgPreload.onload=function(){this.onload=this.onerror=null;a.coming.width=this.width;a.coming.height=this.height;a._afterLoad()};a.imgPreload.onerror=function(){this.onload=this.onerror=null;a._error("image")};a.imgPreload.src=a.coming.href;a.imgPreload.width||a.showLoading()},_loadAjax:function(){a.showLoading();a.ajaxLoad=e.ajax(e.extend({},a.coming.ajax,{url:a.coming.href,error:function(b,c){"abort"!==c?a._error("ajax",b):a.hideLoading()},success:function(b,c){"success"===c&&(a.coming.content=b,a._afterLoad())}}))},_preloadImages:function(){var b=a.group,c=a.current,d=b.length,g;if(c.preload&&!(2>b.length))for(var f=1;f<=Math.min(c.preload,d-1);f++)if(g=b[(c.index+f)%d],g=e(g).attr("href")||g)(new Image).src=g},_afterLoad:function(){a.hideLoading();!a.coming||!1===a.trigger("afterLoad",a.current)?a.coming=!1:(a.isOpened?(e(".fancybox-item").remove(),a.wrap.stop(!0).removeClass("fancybox-opened"),a.inner.css("overflow","hidden"),a.transitions[a.current.prevMethod]()):(e(".fancybox-wrap").stop().trigger("onReset").remove(),a.trigger("afterClose")),a.unbindEvents(),a.isOpen=!1,a.current=a.coming,a.wrap=e(a.current.tpl.wrap).addClass("fancybox-"+(s?"mobile":"desktop")+" fancybox-tmp "+a.current.wrapCSS).appendTo("body"),a.outer=e(".fancybox-outer",a.wrap).css("padding",a.current.padding+"px"),a.inner=e(".fancybox-inner",a.wrap),a._setContent())},_setContent:function(){var b,c,d=a.current,g=d.type;switch(g){case"inline":case"ajax":case"html":b=d.content;b instanceof e&&(b=b.show().detach(),b.parent().hasClass("fancybox-inner")&&b.parents(".fancybox-wrap").trigger("onReset").remove(),e(a.wrap).bind("onReset",function(){b.appendTo("body").hide()}));d.autoSize&&(c=e('<div class="fancybox-tmp '+a.current.wrapCSS+'"></div>').appendTo("body").append(b),d.width=c.width(),d.height=c.height(),c.width(a.current.width),c.height()>d.height&&(c.width(d.width+1),d.width=c.width(),d.height=c.height()),b=c.contents().detach(),c.remove());break;case"image":b=d.tpl.image.replace("{href}",d.href);d.aspectRatio=!0;break;case"swf":b=d.tpl.swf.replace(/\{width\}/g,d.width).replace(/\{height\}/g,d.height).replace(/\{href\}/g,d.href)}if("iframe"===g){b=e(d.tpl.iframe.replace("{rnd}",(new Date).getTime())).attr("scrolling",d.scrolling);d.scrolling="auto";if(d.autoSize){b.width(d.width);a.showLoading();b.data("ready",!1).appendTo(a.inner).bind({onCancel:function(){e(this).unbind();a._afterZoomOut()},load:function(){var b=e(this),c;try{this.contentWindow.document.location&&(c=b.contents().find("body").height()+12,b.height(c))}catch(g){d.autoSize=!1}!1===b.data("ready")?(a.hideLoading(),c&&(a.current.height=c),a._beforeShow(),b.data("ready",!0)):c&&a.update()}}).attr("src",d.href);return}b.attr("src",d.href)}else if("image"===g||"swf"===g)d.autoSize=!1,d.scrolling="visible";a.inner.append(b);a._beforeShow()},_beforeShow:function(){a.coming=null;a.trigger("beforeShow");a._setDimension();a.wrap.hide().removeClass("fancybox-tmp");a.bindEvents();a._preloadImages();a.transitions[a.isOpened?a.current.nextMethod:a.current.openMethod]()},_setDimension:function(){var b=a.wrap,c=a.outer,d=a.inner,g=a.current,f=a.getViewport(),k=g.margin,h=2*g.padding,i=g.width,j=g.height,o=g.maxWidth,l=g.maxHeight,p=g.minWidth,m=g.minHeight,n;f.w-=k[1]+k[3];f.h-=k[0]+k[2];-1<i.toString().indexOf("%")&&(i=(f.w-h)*parseFloat(i)/100);-1<j.toString().indexOf("%")&&(j=(f.h-h)*parseFloat(j)/100);k=i/j;i+=h;j+=h;g.fitToView&&(o=Math.min(f.w,o),l=Math.min(f.h,l));g.aspectRatio?(i>o&&(i=o,j=(i-h)/k+h),j>l&&(j=l,i=(j-h)*k+h),i<p&&(i=p,j=(i-h)/k+h),j<m&&(j=m,i=(j-h)*k+h)):(i=Math.max(p,Math.min(i,o)),j=Math.max(m,Math.min(j,l)));i=Math.round(i);j=Math.round(j);e(b.add(c).add(d)).width("auto").height("auto");d.width(i-h).height(j-h);b.width(i);n=b.height();if(i>o||n>l)for(;(i>o||n>l)&&i>p&&n>m;)j-=10,g.aspectRatio?(i=Math.round((j-h)*k+h),i<p&&(i=p,j=(i-h)/k+h)):i-=10,d.width(i-h).height(j-h),b.width(i),n=b.height();g.dim={width:i,height:n};g.canGrow=g.autoSize&&j>m&&j<l;g.canShrink=!1;g.canExpand=!1;if(i-h<g.width||j-h<g.height)g.canExpand=!0;else if((i>f.w||n>f.h)&&i>p&&j>m)g.canShrink=!0;b=n-h;a.innerSpace=b-d.height();a.outerSpace=b-c.height()},_getPosition:function(b){var c=a.current,d=a.getViewport(),e=c.margin,f=a.wrap.width()+e[1]+e[3],k=a.wrap.height()+e[0]+e[2],h={position:"absolute",top:e[0]+d.y,left:e[3]+d.x};if(c.fixed&&(!b||!1===b[0])&&k<=d.h&&f<=d.w)h={position:"fixed",top:e[0],left:e[3]};h.top=Math.ceil(Math.max(h.top,h.top+(d.h-k)*c.topRatio))+"px";h.left=Math.ceil(Math.max(h.left,h.left+.5*(d.w-f)))+"px";return h},_afterZoomIn:function(){var b=a.current,c=b.scrolling;a.isOpen=a.isOpened=!0;a.wrap.addClass("fancybox-opened").css("overflow","visible");a.update();a.inner.css("overflow","yes"===c?"scroll":"no"===c?"hidden":c);if(b.closeClick||b.nextClick)a.inner.css("cursor","pointer").bind("click.fb",b.nextClick?a.next:a.close);b.closeBtn&&e(b.tpl.closeBtn).appendTo(a.outer).bind("click.fb",a.close);b.arrows&&1<a.group.length&&((b.loop||0<b.index)&&e(b.tpl.prev).appendTo(a.inner).bind("click.fb",a.prev),(b.loop||b.index<a.group.length-1)&&e(b.tpl.next).appendTo(a.inner).bind("click.fb",a.next));a.trigger("afterShow");a.opts.autoPlay&&!a.player.isActive&&(a.opts.autoPlay=!1,a.play())},_afterZoomOut:function(){a.trigger("afterClose");a.wrap.trigger("onReset").remove();e.extend(a,{group:{},opts:{},current:null,isActive:!1,isOpened:!1,isOpen:!1,wrap:null,outer:null,inner:null})}});a.transitions={getOrigPosition:function(){var b=a.current,c=b.element,d=b.padding,g=e(b.orig),f={},k=50,h=50;!g.length&&b.isDom&&e(c).is(":visible")&&(g=e(c).find("img:first"),g.length||(g=e(c)));g.length?(f=g.offset(),g.is("img")&&(k=g.outerWidth(),h=g.outerHeight())):(b=a.getViewport(),f.top=b.y+.5*(b.h-h),f.left=b.x+.5*(b.w-k));return f={top:Math.ceil(f.top-d)+"px",left:Math.ceil(f.left-d)+"px",width:Math.ceil(k+2*d)+"px",height:Math.ceil(h+2*d)+"px"}},step:function(b,c){var d,e,f;if("width"===c.prop||"height"===c.prop)e=f=Math.ceil(b-2*a.current.padding),"height"===c.prop&&(d=(b-c.start)/(c.end-c.start),c.start>c.end&&(d=1-d),e-=a.innerSpace*d,f-=a.outerSpace*d),a.inner[c.prop](e),a.outer[c.prop](f)},zoomIn:function(){var b=a.wrap,c=a.current,d,g;d=c.dim;"elastic"===c.openEffect?(g=e.extend({},d,a._getPosition(!0)),delete g.position,d=this.getOrigPosition(),c.openOpacity&&(d.opacity=0,g.opacity=1),a.outer.add(a.inner).width("auto").height("auto"),b.css(d).show(),b.animate(g,{duration:c.openSpeed,easing:c.openEasing,step:this.step,complete:a._afterZoomIn})):(b.css(e.extend({},d,a._getPosition())),"fade"===c.openEffect?b.fadeIn(c.openSpeed,a._afterZoomIn):(b.show(),a._afterZoomIn()))},zoomOut:function(){var b=a.wrap,c=a.current,d;"elastic"===c.closeEffect?("fixed"===b.css("position")&&b.css(a._getPosition(!0)),d=this.getOrigPosition(),c.closeOpacity&&(d.opacity=0),b.animate(d,{duration:c.closeSpeed,easing:c.closeEasing,step:this.step,complete:a._afterZoomOut})):b.fadeOut("fade"===c.closeEffect?c.closeSpeed:0,a._afterZoomOut)},changeIn:function(){var b=a.wrap,c=a.current,d;"elastic"===c.nextEffect?(d=a._getPosition(!0),d.opacity=0,d.top=parseInt(d.top,10)-200+"px",b.css(d).show().animate({opacity:1,top:"+=200px"},{duration:c.nextSpeed,easing:c.nextEasing,complete:a._afterZoomIn})):(b.css(a._getPosition()),"fade"===c.nextEffect?b.hide().fadeIn(c.nextSpeed,a._afterZoomIn):(b.show(),a._afterZoomIn()))},changeOut:function(){var b=a.wrap,c=a.current,d=function(){e(this).trigger("onReset").remove()};b.removeClass("fancybox-opened");"elastic"===c.prevEffect?b.animate({opacity:0,top:"+=200px"},{duration:c.prevSpeed,easing:c.prevEasing,complete:d}):b.fadeOut("fade"===c.prevEffect?c.prevSpeed:0,d)}};a.helpers.overlay={overlay:null,update:function(){var a,c;this.overlay.width(0).height(0);e.browser.msie?(a=Math.max(m.documentElement.scrollWidth,m.body.scrollWidth),c=Math.max(m.documentElement.offsetWidth,m.body.offsetWidth),a=a<c?l.width():a):a=q.width();this.overlay.width(a).height(q.height())},beforeShow:function(b){this.overlay||(b=e.extend(!0,{speedIn:"fast",closeClick:!0,opacity:1,css:{background:"black"}},b),this.overlay=e('<div id="fancybox-overlay"></div>').css(b.css).appendTo("body"),this.update(),b.closeClick&&this.overlay.bind("click.fb",a.close),l.bind("resize.fb",e.proxy(this.update,this)),this.overlay.fadeTo(b.speedIn,b.opacity))},onUpdate:function(){this.update()},afterClose:function(a){this.overlay&&this.overlay.fadeOut(a.speedOut||0,function(){e(this).remove()});this.overlay=null}};a.helpers.title={beforeShow:function(b){var c;if(c=a.current.title)c=e('<div class="fancybox-title fancybox-title-'+b.type+'-wrap">'+c+"</div>").appendTo("body"),"float"===b.type&&(c.width(c.width()),c.wrapInner('<span class="child"></span>'),a.current.margin[2]+=Math.abs(parseInt(c.css("margin-bottom"),10))),c.appendTo("over"===b.type?a.inner:"outside"===b.type?a.wrap:a.outer)}};e.fn.fancybox=function(b){var c=e(this),d=this.selector||"",g,f=function(f){var h=this,i="rel",j=h[i],l=g;!f.ctrlKey&&!f.altKey&&!f.shiftKey&&!f.metaKey&&(f.preventDefault(),j||(i="data-fancybox-group",j=e(h).attr("data-fancybox-group")),j&&""!==j&&"nofollow"!==j&&(h=d.length?e(d):c,h=h.filter("["+i+'="'+j+'"]'),l=h.index(this)),b.index=l,a.open(h,b))},b=b||{};g=b.index||0;d?q.undelegate(d,"click.fb-start").delegate(d,"click.fb-start",f):c.unbind("click.fb-start").bind("click.fb-start",f);return this}})(window,document,jQuery);(function($,F){var W=$(window),D=$(document),isMobile=typeof document.createTouch!=="undefined";$.extend(F.defaults,{wrapCSS:"photoset-fancybox",scrolling:"visible",aspectRatio:true,loop:false,prevSpeed:600,nextSpeed:600,keys:{next:[13,32,39],prev:[37],close:[27]},helpers:{overlay:null,PhotosetOverlay:{}}});F.transitions.changeIn=function(){var wrap=F.wrap,current=F.current,startPos=F._getPosition(true);if(!F.isForward){startPos.left=parseInt(startPos.left,10)-1500+"px";wrap.css(startPos).show().animate({left:"+=1500px"},{duration:current.nextSpeed,complete:F._afterZoomIn})}else{startPos.left=parseInt(startPos.left,10)+1500+"px";wrap.css(startPos).show().animate({left:"-=1500px"},{duration:current.nextSpeed,complete:F._afterZoomIn})}};F.transitions.changeOut=function(){var wrap=F.wrap,current=F.current,cleanUp=function(){$(this).trigger("onReset").remove()},leftAmt;wrap.removeClass("fancybox-opened");if(F.isForward){leftAmt="-=1500px"}else{leftAmt="+=1500px"}if(current.prevEffect==="elastic"){wrap.animate({opacity:.4,left:leftAmt},{duration:current.prevSpeed,complete:cleanUp})}};F.next=function(){if(F.current){F.isForward=true;F.jumpto(F.current.index+1)}};F.prev=function(){if(F.current){F.isForward=false;F.jumpto(F.current.index-1)}};F.closeOrig=F.close;F.close=function(a){if(typeof a==="object"&&a.target){var target=$(a.target);if(target.attr("id")===F.overlayId||target.hasClass("fancybox-close")&&$(this).attr("id")!==F.overlayId||target.hasClass("transparency"))F.closeOrig(a);return}F.closeOrig(a)};F._afterZoomOut=function(){F.trigger("afterClose")};F.getViewport=function(){return{x:W.scrollLeft(),y:0,w:W.width(),h:W.height()}};F.originalUrl=window.location.href;F.overlayId="photoset-overlay";F.overlayWrap='<div id="'+F.overlayId+'"><div class="transparency"></div></div>';F.helpers.PhotosetOverlay={overlay:null,beforeLoad:function(opts){if(this.overlay){return}opts=$.extend(true,{speedIn:"fast",closeClick:true},opts);this.overlay=$(F.overlayWrap).appendTo("body");if(opts.closeClick){this.overlay.bind("click.fb",F.close)}this.overlay.fadeTo(opts.speedIn,opts.opacity)},beforeShow:function(opts){F.wrap.detach().appendTo("div#"+F.overlayId)},afterClose:function(opts){F.wrap.trigger("onReset").remove();if(this.overlay){this.overlay.remove();this.overlay=null}$.extend(F,{group:{},opts:{},current:null,isActive:false,isOpened:false,isOpen:false,wrap:null,outer:null,inner:null})}}})(jQuery,jQuery.fancybox);!function($){$.fn.notes=function(method){var methods;methods={};methods.init=function(options,editable,container){methods.setEditable(editable);return this.each(function(){var noteHolder,self;self=$(this);noteHolder=$('<div class="note-holder"></div>');return setTimeout(function(){var makeOptions,nfo,option,_i,_len,_results;nfo=methods.extractInfo(self,container);noteHolder.addClass(nfo.imgId);noteHolder.attr("id","holder_"+nfo.imgId);methods.placeNoteHolder(noteHolder,nfo);if(container!=null){container.append(noteHolder)}else{$("body").append(noteHolder)}if(methods.editable){noteHolder.css({"z-index":200});methods.bindNoteHolder(noteHolder)}makeOptions=function(opt){var literal;opt.parentWidth=nfo.width;opt.parentHeight=nfo.height;opt.noteHolder=noteHolder;literal=[opt];return methods.display.apply(self,literal)};if(options){_results=[];for(_i=0,_len=options.length;_i<_len;_i++){option=options[_i];_results.push(makeOptions(option))}return _results}},10)})};methods.extractInfo=function(elm,container){var compoundClass,eclass,height,imgId,offset,width;width=elm.width();height=elm.height();eclass=elm.attr("class");offset=container?elm.offsetParent().position():elm.offset();if(eclass!=null){compoundClass=eclass.indexOf(" ")}if(compoundClass!=null&&compoundClass!==-1){imgId=eclass.split(" ")[1]}else{imgId=eclass}return{width:width,height:height,offset:offset,imgId:imgId}};methods.placeNoteHolder=function(noteHolder,nfo){if(nfo!=null&&nfo.offset!=null){return noteHolder.css({left:nfo.offset.left+"px",top:nfo.offset.top+"px"})}};methods.buildNoteInfo=function(note,action){var data,height,hheight,holder,hwidth,imgId,left,pos,text,top,width;pos=note.position();holder=note.parent();hwidth=holder.width();hheight=holder.height();imgId=holder.attr("class").split(" ")[1].substring(3);data={};data.action=action;data.imageID=imgId;top=pos.top/hheight;left=pos.left/hwidth;width=note.width()/hwidth;height=note.height()/hheight;text=note.find("textarea").val();if(!text){text=note.find(".note-text-value").html()}if(text){data.text=text.replace(/\n/g,"<br/>").replace(/"/g,'\\"')}data.json='{"top":'+top+',"left":'+left+',"width":'+width+',"height":'+height+',"text":"'+data.text+'"}';return data};methods.add=function(note){var data;data=methods.buildNoteInfo(note,"ADD");return $.post("/ajax/imageNote",data,function(response){note.attr("id",response);note.find(".note-text").html(methods.buildTextNode(data.text.replace(/\\"/g,'"')));return methods.bind(note)},"text")};methods.buildTextNode=function(text){return $('<div class="note-text-value">'+text+'</div><a class="edit-note" href="#">edit</a>')};methods.buildEditNode=function(text,classname){text=text.replace(/<br>/g,"\n");if(!classname){return $("<textarea>"+text+'</textarea><br/><a class="delete little-button" href="#">delete</a><a class="save little-button" href="#">save</a>')}else{return $("<textarea>"+text+'</textarea><br/><a class="delete little-button" href="#">delete</a><a class="'+classname+' little-button" href="#">save</a>')}};methods.save=function(note){var data;data=methods.buildNoteInfo(note,"MODIFY");data.noteID=note.attr("id");if(data.noteID){return $.post("/ajax/imageNote",data,function(response){return methods.bind(note)})}};methods.update=function(note){var noteText,text;noteText=note.find(".note-text");text=noteText.find(".note-text-value").html();noteText.html(methods.buildEditNode(text,"edit"));methods.bind(note);return noteText.find("a.edit").click(function(evt){var data;evt.preventDefault();data=methods.buildNoteInfo(note,"MODIFY");if(data.text!=null){data.noteID=note.attr("id");return $.post("/ajax/imageNote",data,function(response){noteText.html(methods.buildTextNode(noteText.find("textarea").val()));return methods.bind(note)})}else{return feedBack.add("Please enter text in order to save.")}})};methods.remove=function(note){var data;data=methods.buildNoteInfo(note,"DELETE");data.noteID=note.attr("id");if(data.noteID){$.post("/ajax/imageNote",data)}return note.fadeOut(function(){return note.remove()})};methods.bindNoteHolder=function(holder){var note;note=null;$("div.note-holder").mousedown(function(evt){evt.preventDefault();note=methods.userCreateBox(evt,holder);return methods.bind(note,note.height())});return this};methods.display=function(note){var left,noteHeight,noteWidth,top;left=Math.round(note.parentWidth*note.left);top=Math.round(note.parentHeight*note.top);noteWidth=Math.round(note.parentWidth*note.width);noteHeight=Math.round(note.parentHeight*note.height);methods.drawBox({left:left,top:top,width:noteWidth,height:noteHeight,note:note});return this};methods.drawBox=function(opts){var note,noteid;noteid=opts.note.id?opts.note.id:opts.note.noteID;note=$('<div id="'+noteid+'" class="note-border"><div class="note-text"><div class="note-text-value">'+opts.note.text+"</div></div></div>");opts.note.noteHolder.append(note);if(methods.editable){note.find(".note-text").append('<a href="#" class="edit-note">edit</a>')}note.css({width:opts.width+"px",left:opts.left+"px",height:opts.height+"px",top:opts.top+"px"});methods.bind(note,opts.height);return this};methods.userCreateBox=function(evt,noteHolder){var note;note=$('<div class="note-border"><div class="note-text"></div></div>');note.find(".note-text").append(methods.buildEditNode(""));noteHolder.append(note);note.mousedown(function(md_evt){return md_evt.stopPropagation()});if(!/MSIE (\d+\.\d+);/.test(navigator.userAgent)){note.css({top:evt.layerY+"px",left:evt.layerX+"px",width:"50px",height:"50px"})}else{note.css({top:evt.offsetY+"px",left:evt.offsetX+"px",width:"50px",height:"50px"})
}return note};methods.updateBoxSize=function(evt,note){var pos;pos=note.position();return note.css({width:Math.abs(pos.left+evt.layerX)+"px",height:Math.abs(pos.top+evt.layerY)+"px"})};methods.setNoteTextTop=function(noteText,height){return noteText.css({top:height+"px"})};methods.noteHover=function(note,height,noteText){var hovering,_self;_self=this;hovering=note.hover(function(){clearTimeout(_self.timer);methods.setNoteTextTop(noteText,height);$("div.note-text").hide();return noteText.show()},function(){clearTimeout(_self.timer);return _self.timer=setTimeout(function(){return noteText.fadeOut()},1500)});return hovering};methods.setEditable=function(bool){this.editable=bool;return this};methods.bind=function(note,height){var hovering,noteText,self;noteText=note.find("div.note-text");hovering=methods.noteHover(note,height,noteText);if(methods.editable){self=this;if(note.resizable!=null){note.resizable({containment:"parent",start:function(event,ui){noteText.hide();return note.unbind("hover",hovering)},resize:function(event,ui){noteText.hide();return note.unbind("hover",hovering)},stop:function(event,ui){height=note.height();hovering=methods.noteHover(note,height,noteText);methods.setNoteTextTop(noteText,height);methods.save(note);return noteText.show()}})}if(note.draggable!=null){note.draggable({containment:"parent",stop:function(event,ui){return methods.save(note)}})}note.mousedown(function(evt){return evt.stopPropagation()});noteText.find("a.save").click(function(evt){evt.preventDefault();return methods.add(note)});noteText.find("a.delete").click(function(evt){evt.preventDefault();return methods.remove(note)});return noteText.find("a.edit-note").click(function(evt){evt.preventDefault();return methods.update(note)})}};if(methods[method]){return methods[method].apply(this,Array.prototype.slice.call(arguments,1))}else if(typeof method==="object"||!method){return methods.init.apply(this,arguments)}else{return $.error("Method "+method+" does not exist on jQuery.notes")}}}(window.jQuery);(function($,_,Backbone){var defaults={width:"100%",gutter:"0px",layout:null,variableLayout:false,maxRowsVisible:null,aspectRatioRowOfOneThreshold:null};function Photoset(element,options){this.$element=$(element);this.photosetItems=[];this.photosetRows=[];this.photoDimensions={"large-image":{height:768,width:1024},"medium-image":{height:465,width:620},"small-image":{height:320,width:427}};this.rows=[];this.options=$.extend({},defaults,options);this.init()}Photoset.prototype={init:function(){this.setupLayout(this.$element,this.options)},getRowCount:function(){return this.rows.length},setLazyloadPropertiesForImage:function($imgItem,imageSize){var $img=$imgItem.find("img");$img.attr("data-original",$img.data(imageSize));$img.attr("width",this.photoDimensions[imageSize]["width"]);$img.attr("height",this.photoDimensions[imageSize]["height"])},setLazyloadPropertiesForImages:function($imgItems,beginIndex,endIndex,imageSize){for(var i=beginIndex;i<=endIndex;i++){this.setLazyloadPropertiesForImage($imgItems.eq(i),imageSize)}},getHeightProportionalToCellWidth:function($img,photosetWidth){var parentCellPercentageWidth=$img.closest(".photoset-cell").width(),parentCellProportialWidth=parentCellPercentageWidth/100*(photosetWidth-10);return Math.floor($img.data("orig-height")/$img.data("orig-width")*parentCellProportialWidth)},setupLayout:function($elem,options){var self=this;this.photosetItems=$elem.find(".photoset-item");if(options.variableLayout||$elem.data("variable-layout")){this.setupRowsUsingVariableLayoutStrategy($elem,options)}else{this.setupRows($elem,options)}this.processRows($elem,options);this.processColumns($elem,options);_.defer(function(){$elem.trigger("photoset.imageloaded",$elem.find("img:not(.lazy-img)"))});$elem.find(".lazy-img").lazyload({effect:"fadeIn",threshold:10,failure_limit:3,skip_invisible:false,load:function(){$elem.trigger("photoset.imageloaded",$(this))}});this.resizePhotosetGrid();$(window).on("resize",_.debounce(function(){self.resizePhotosetGrid()},1e3));this.showHiddenRowsUpToMaxRowsVisible()},setupRows:function($elem,options){var $items=this.photosetItems;if(options.layout){this.layout=options.layout}else if($elem.data("layout")){this.layout=$elem.data("layout")}else{var stackedLayout="";var defaultColumns=1;for(var numItems=0;numItems<$items.length;numItems++){stackedLayout=stackedLayout+defaultColumns.toString()}this.layout=stackedLayout}this.rows=this.layout.split("");for(var i in this.rows){this.rows[i]=parseInt(this.rows[i],10)}},setupRowsUsingVariableLayoutStrategy:function($elem,options){var lastFileWasVideoEmbed=false,$tempItems=$(),rows=[],self=this;this.photosetItems.each(function(){var $photosetItem=$(this);if($photosetItem.hasClass("photoset-video")){if(!lastFileWasVideoEmbed&&!_.isEmpty($tempItems)){self.appendPhotosetImageRows(rows,$tempItems,options);$tempItems=$()}$tempItems.push(this);lastFileWasVideoEmbed=true}else if($photosetItem.hasClass("photoset-image")){if(lastFileWasVideoEmbed&&!_.isEmpty($tempItems)){self.appendPhotosetVideoRows(rows,$tempItems,options);$tempItems=$()}$tempItems.push(this);lastFileWasVideoEmbed=false}});if(!_.isEmpty($tempItems)){if(lastFileWasVideoEmbed){self.appendPhotosetVideoRows(rows,$tempItems,options)}else{self.appendPhotosetImageRows(rows,$tempItems,options)}}this.rows=rows},appendPhotosetVideoRows:function(rows,videos,options){var self=this;videos.each(function(){rows.push(1)})},appendPhotosetImageRows:function(rows,$imageItems,options){var numImages=$imageItems.length;if(numImages<=6){rows.push(1);this.setLazyloadPropertiesForImage($imageItems.eq(0),"medium-image");if(numImages==2){rows.push(1);this.setLazyloadPropertiesForImage($imageItems.eq(1),"medium-image")}else if(numImages==3){rows.push(2);this.setLazyloadPropertiesForImages($imageItems,1,2,"medium-image")}else if(numImages==4){rows.push(3);this.setLazyloadPropertiesForImages($imageItems,1,3,"small-image")}else if(numImages==5){rows.push(2);rows.push(2);this.setLazyloadPropertiesForImages($imageItems,1,4,"medium-image")}else if(numImages==6){rows.push(2);rows.push(3);this.setLazyloadPropertiesForImages($imageItems,1,2,"medium-image");this.setLazyloadPropertiesForImages($imageItems,3,5,"small-image")}}else{var partitions=parseInt($imageItems.length/6);for(var i=0;i<partitions;i++){this.appendPhotosetImageRows(rows,$imageItems.slice(i*6,(i+1)*6),options)}var rem=$imageItems.length%6;if(rem>0){this.appendPhotosetImageRows(rows,$imageItems.slice($imageItems.length-rem),options)}}},processRows:function($elem,options){var $items=this.photosetItems,itemIndex=0;$.each(this.rows,function(i,val){var rowStart=itemIndex,rowEnd=itemIndex+val,rowHidden="",$itemSlice=$items.slice(rowStart,rowEnd);if($itemSlice.hasClass("hidden-item"))rowHidden=" hidden-row";var $newRow=$itemSlice.wrapAll('<div class="photoset-row cols-'+val+rowHidden+'"></div>');$itemSlice.removeClass("hidden-item");itemIndex=rowEnd});$elem.find(".photoset-row:not(:last-child)").css({"margin-bottom":options.gutter});this.photosetRows=$elem.find(".photoset-row")},processColumns:function($elem,options){var $rows=this.photosetRows,$items=this.photosetItems;$items.each(function(){$(this).wrapAll('<div class="photoset-cell" />')});var $cells=$elem.find(".photoset-cell"),$cols1=$elem.find(".cols-1 .photoset-cell"),$cols2=$elem.find(".cols-2 .photoset-cell"),$cols3=$elem.find(".cols-3 .photoset-cell"),$cols4=$elem.find(".cols-4 .photoset-cell"),$cols5=$elem.find(".cols-5 .photoset-cell");$rows.css({clear:"left",overflow:"hidden"});$cells.css({"float":"left",display:"block","line-height":"0","-webkit-box-sizing":"border-box","-moz-box-sizing":"border-box","box-sizing":"border-box"});$cols1.css({width:"100%"});$cols2.css({width:"50%"});$cols3.css({width:"33.3%"});$cols4.css({width:"25%"});$cols5.css({width:"20%"});var gutterVal=parseInt(options.gutter,10);$elem.find(".photoset-cell:not(:last-child)").css({"padding-right":gutterVal/2+"px"});$elem.find(".photoset-cell:not(:first-child)").css({"padding-left":gutterVal/2+"px"})},resizePhotosetGrid:function(){var self=this,$elem=this.$element,photosetWidth=$elem.width().toString(),$rows=this.photosetRows;if(photosetWidth!==$elem.data("width")){$elem.trigger("photoset.beforeResize");$rows.each(function(){if($(this).hasClass("cols-1")){var $img1=$(this).find("img:eq(0)");if("none"===$img1.css("maxWidth")){$img1.css("maxWidth",$img1.data("orig-width")+"px")}}if($(this).hasClass("cols-2")){var $img1=$(this).find("img:eq(0)"),$img2=$(this).find("img:eq(1)");var img1OrigWidth=$img1.data("orig-width"),img2OrigWidth=$img2.data("orig-width"),totalWidth=img1OrigWidth+img2OrigWidth;var img1ColPercent=Math.floor(img1OrigWidth/totalWidth*100),img2ColPercent=100-img1ColPercent;var cells=$(this).find(".photoset-cell");cells.eq(0).css({width:img1ColPercent+"%"});cells.eq(1).css({width:img2ColPercent+"%"})}if(!$(this).hasClass("cols-1")){var shortestImgHeight=1e5,$shortestImg;$(this).find("img").each(function(){var $candidateImg=$(this),candidateImgHeight=$candidateImg.data("orig-height");if(candidateImgHeight<shortestImgHeight){$shortestImg=$candidateImg;shortestImgHeight=candidateImgHeight}});var rowHeight=self.getHeightProportionalToCellWidth($shortestImg,photosetWidth);$(this).height(rowHeight);$(this).find("img").each(function(){var $img=$(this),imgHeight=self.getHeightProportionalToCellWidth($img,photosetWidth);var marginOffset=(rowHeight-imgHeight)*.5+"px";$img.css({"margin-top":marginOffset})})}});$elem.data("width",photosetWidth);$elem.trigger("photoset.afterResize")}},showHiddenRowsUpToMaxRowsVisible:function(){var maxRowsVisible=this.options.maxRowsVisible,shouldHideRows=false,$elem=this.$element,$rows=null,self=this;if(maxRowsVisible&&this.getRowCount()>maxRowsVisible)shouldHideRows=true;if(!shouldHideRows){this.showAllRows()}else{$rows=$elem.find(".photoset-row");for(var i=0;i<maxRowsVisible;i++){$rows.eq(i).removeClass("hidden-row")}}},showAllRows:function(){this.$element.find(".hidden-row").removeClass("hidden-row")}};$.fn.photoset=function(options){return this.each(function(){var $this=$(this),data=$this.data("photoset");if(!data)$this.data("photoset",data=new Photoset(this,options));if(typeof options=="string")data[option].call($this)})};var PhotosetView=Backbone.View.extend({events:{"click a.photoset-link":"photosetLinkClicked","click a.photoset-showmore":"showAllPhotosetRows"},initialize:function(options){_.bindAll(this,"beforePhotosetResize","afterPhotosetResize","renderImageNotes");this.$el.photoset(options);this.maxRowsVisible=options.maxRowsVisible;this.photoset=this.$el.data("photoset");this.enableShowMoreToggle();this.bindEvents()},bindEvents:function(){this.$el.on("photoset.beforeResize",this.beforePhotosetResize);this.$el.on("photoset.afterResize",this.afterPhotosetResize);this.$el.on("photoset.imageloaded",this.renderImageNotes)},enableShowMoreToggle:function(){var maxRowsVisible=this.maxRowsVisible;if(maxRowsVisible){if(this.photoset.getRowCount()>maxRowsVisible){this.$el.find(".photoset-showmore").css({display:"block"})}}},renderImageNotes:function(event,images){var $images=$(images);$images.each(function(){var $image=$(this),notesContainer=$image.closest(".photoset-link"),imageNotes=$image.data("notes"),imageId=$image.data("image-id");if($image.closest(".photoset-row").children().size()===1){if(imageNotes&&imageNotes.length){$image.addClass("photo img"+imageId);$image.notes(imageNotes,false,notesContainer)}}})},beforePhotosetResize:function(){this.$el.find(".note-holder").remove()},afterPhotosetResize:function(){this.renderImageNotes()},showAllPhotosetRows:function(){this.$el.find(".photoset-showmore").hide();this.photoset.showAllRows()},photosetLinkClicked:function(e){e.preventDefault();new PhotosetOverlay({el:this.el})}});var PhotosetOverlay=Backbone.View.extend({initialize:function(){this.render()},render:function(){var $photosetLinks=this.$el.find(".photoset-link"),self=this;if(!this.processedPhotosetLinks){_.each($photosetLinks,function(link){var $link=$(link);$link.data("original-href",$link.attr("href"));$(link).attr("href",$(link).data("fancybox-href"))});this.processedPhotosetLinks=true}$photosetLinks.fancybox({afterShow:function(){var $fancyBoxInner=$(".fancybox-inner"),$currentLink=$(this.element);if($fancyBoxInner.length){var galleryImg=$fancyBoxInner.find("img:first"),notesJson=$currentLink.find("img:first").data("notes");if(notesJson){galleryImg.notes(notesJson,false,$fancyBoxInner)}$fancyBoxInner.find(".fancybox-image").one("click",function(e){window.location.href=$currentLink.data("original-href")})}}})}});window.PhotosetView=PhotosetView})(jQuery,_,Backbone);Ibles.package("Ibles.models","Ibles.collections");Ibles.collections.FileSet=Backbone.Collection.extend({model:Backbone.Model,idArray:function(){return this.map(function(file){return{id:file.get("id")}})}});Ibles.package("Ibles.models","Ibles.collections");Ibles.models.CommentModel=Backbone.Model.extend({defaults:function(){return{instructableId:Ibles.pageContext.ibleData.id,author:Ibles.session.get("screenName"),authorId:Ibles.session.get("id"),avatar:Ibles.session.get("tinyUrl"),fileSet:Ibles.pageContext.mobile||!Ibles.session.authenticated()?new Ibles.collections.FileSet:new ibles.FileSet,IMadeIt:false,replyAuthor:null,quarantine:false,limbo:false,status:null}},initialize:function(){if(!_.isUndefined(this.get("publishDate"))){this.set({commentTime:this.setRelDate()})}if(_.isUndefined(this.get("authorUrl"))){this.set({authorUrl:Ibles.reverseUrls.memberUrl(this.get("author"))})}if(!_.isEmpty(this.get("files"))){this.get("fileSet").add(this.get("files"))}if(this.get("status")==="DELETED"){this.setDeletedBody()}},setRelDate:function(){var publishDate=this.get("publishDate");var pubDate=new Date(publishDate),newDate=new Date(moment());if(pubDate>newDate){return Ibles.attemptTranslationOfString("a few seconds ago")}else{return moment(publishDate).fromNow()}},setDeletedBody:function(){this.set({body:Ibles.attemptTranslationOfString("(removed by author or community request)")})},postCommentAction:function(){var that=this,params=_.pick(this.toJSON(),"instructableId","author","IMadeIt","body","inReplyTo"),promise,fileSet=this.get("fileSet");if(!fileSet.isEmpty()){if(_.isFunction(fileSet.idArray)){params.images=fileSet.idArray()}else{params.images=fileSet.map(function(file){return{id:file.get("id")}})}}promise=Ibles.API.jsonPostRequest("addComment",params,{success:function(data){that.set({id:data["id"],commentTime:"a few seconds ago",publishDate:moment().fromNow()});if(_.isUndefined(that.get("inReplyTo"))){Ibles.COMMENTCOLLECTION.add(that,{at:0})}else{Ibles.COMMENTCOLLECTION.add(that,{at:Ibles.COMMENTCOLLECTION.findIndexOfComment(that.get("inReplyTo"))+1});Ibles.COMMENTCOLLECTION.dirtyTree=true}},error:function(data){var errorMessage;if(data&&data["validationErrors"]){var errorKeys=Object.keys(data.validationErrors);if(errorKeys.length>1){errorMessage=Ibles.locale.errors.incompleteFormError}else{errorMessage=data.validationErrors[errorKeys[0]]}}else{errorMessage=Ibles.toLocaleError(data,Ibles.locale.errors.somethingWentWrong)}that.trigger("comment.postError",errorMessage)}},"id");return promise},deleteComment:function(){var that=this;return Ibles.API.postRequest("deleteComment",{id:this.get("id")},{success:function(data){if(that.collection.getChildrenArray(that).length>0){that.setDeletedBody()}else{that.collection.remove(that)}}})},deleteThread:function(){var that=this;return Ibles.API.postRequest("deleteThread",{id:this.get("id")},{success:function(data){that.collection.deleteThread(that)}})},setIMadeIt:function(value){var options={id:this.get("id"),value:value},promise=$.ajax({url:"/json-api/setIMadeIt",dataType:"json",type:"POST",data:options});return promise},flagComment:function(flagName){var self=this,params={id:this.get("id"),flag:flagName};return Ibles.API.postRequest("setFlag",params)},limbo:function(){var params={action:"LIMBO",objectIds:this.get("id"),type:"C"},that=this;return Ibles.API.adminAjaxRequest("quarantine",params,{success:function(data){that.set({limbo:true})}})},unquarantine:function(){var params={action:"PUBLISH",objectIds:this.get("id"),type:"C"},self=this;return Ibles.API.adminAjaxRequest("quarantine",params,{success:function(data){self.set({quarantine:false,status:"PUBLISHED"})}})},toggleStickyComment:function(sticky){var params={entryID:this.get("id"),type:"FORUM_COMMENT"},that=this;return Ibles.API.ajaxRequest("sticky",params,{success:function(data){that.set({sticky:sticky})}})},toggleApproval:function(checked){var status=checked===true?"CHECKED":"UNCHECKED",params={entryID:this.get("id"),status:status},that=this;return Ibles.API.ajaxRequest("approve",params,{success:function(data){that.set({approved:checked})}})}});Ibles.collections.CommentCollection=Backbone.Collection.extend({numCommentsToLoad:50,dirtyTree:false,model:Ibles.models.CommentModel,initialize:function(){_.bindAll(this,"deleteThread","getChildrenArray")},findIndexOfComment:function(id){return this.indexOf(this.findWhere({id:id}))},deleteThread:function(model){var children=this.getChildrenArray(model),parents=this.getParents(model);this.remove(children);this.remove(model);this.remove(parents)},fetchComments:function(){if(!this.dirtyTree){var that=this,id=Ibles.pageContext.ibleData.id,deferred=Ibles.API.getRequest("getComments",{instructableId:id,limit:this.numCommentsToLoad,offset:this.length},{success:function(data){that.add(data.comments)}});return deferred}else{return this.reloadCommentTree()}},reloadCommentTree:function(){var that=this,id=Ibles.pageContext.ibleData.id,deferred=Ibles.API.getRequest("getComments",{instructableId:id,limit:this.numCommentsToLoad+this.length,offset:0},{success:function(data){that.reset(data.comments)}});return deferred},getParents:function(model){var that=this,parents=[],getParent=function(model){var parentId=model.get("inReplyTo");if(!_.isUndefined(parentId)){parents.push(parentId);getParent(that.get(parentId))}else{return parents}};return getParent(model)},getChildrenArray:function(model){var that=this,children=[],getChildren=function(model){var levelChildren=that.where({inReplyTo:model.get("id")});if(levelChildren.length>0){children=children.concat(_.pluck(levelChildren,"id"));_.each(levelChildren,getChildren)}};getChildren(model);return children}});Ibles.package("Ibles.views");Ibles.views.CommentManager=Backbone.View.extend({el:"#commentsWrapper",events:{"click #see-more-comments":"addComments"},initialize:function(){_.bindAll(this,"addComments","renderComment");var that=this;this.$("#loaded-comments").remove();window.Ibles.COMMENTCOLLECTION=new Ibles.collections.CommentCollection;this.collection=window.Ibles.COMMENTCOLLECTION;window.Ibles.ACHIEVEMENTS=new Ibles.models.Achievements;this.achievements=window.Ibles.ACHIEVEMENTS;sessionReady(function(){that.addComments();new Ibles.views.CommentPostingView});this.listenTo(this.collection,"add",this.renderComment);this.listenTo(this.collection,"reset",this.reRenderAllComments)},addComments:function(){var that=this;this.achievements.clearAuthors();this.collection.fetchComments().done(function(data){if(data.comments.length<that.collection.numCommentsToLoad){$("#see-more-comments").hide()}that.achievements.fetch();that.trigger("commentsRendered")})},renderComment:function(comment){var view=new Ibles.views.CommentView({model:comment}),comments=this.$("#comment-list .comment-container"),commentIndex=comment.collection.indexOf(comment);if(commentIndex===0){$("#comment-list").prepend(view.render())}else if(commentIndex===comments.length){$("#comment-list").append(view.render())}else{comments.eq(commentIndex).before(view.render())}},reRenderAllComments:function(){this.$("#comment-list").css({"min-height":$("#comment-list").outerHeight()});this.$("#comment-list").empty();this.collection.each(this.renderComment);this.$("#comment-list").css({"min-height":"initial"})}});Ibles.views.CommentView=Backbone.View.extend({quarantineMessage:"THIS COMMENT HAS BEEN QUARANTINED",className:function(){if(_.isUndefined(this.model.get("inReplyTo"))){return"comment-container clearfix"}else{return"comment-container reply clearfix"}},events:{"click .replyToCommentBtn":"renderReplyUI","click .imadeit-check":"setIMadeItAction","click .deleteComment":"deleteCommentAction","click .deleteThread":"deleteThreadAction","click .flagComment .dropdown-menu a":"flagComment","click .limboBtn":"limboComment","click .unquarantine-btn":"unquarantineComment","click .sticky-check":"toggleSticky","click .approved-check":"toggleApproval","click .reply-to":"scrollToParent"},initialize:function(){_.bindAll(this,"remove");this.template=Ibles.templateCache("#template-comment-list-item");this.setUpAchievements();this.listenTo(this.model,"change",this.render);this.listenTo(this.model,"remove",this.remove)},setUpAchievements:function(){this.achievents=window.Ibles.ACHIEVEMENTS;this.achievents.addAuthor(this.model.get("authorId"))},render:function(){this.$el.html(this.template(this.model.toJSON()));if((this.model.get("limbo")||this.model.get("quarantine")&&!Ibles.session.isAdmin())&&this.model.get("author")!==Ibles.session.get("screenName")){this.$el.hide()}if(Ibles.session.isAdmin()){this.$(".deleteComment,.deleteThread,.imadeit-checkbox,.limboBtn,.sticky-comment-checkbox,.approved-checkbox").show();if(this.model.get("quarantine")){this.$(".quarantine-message").html(this.quarantineMessage);this.$(".unquarantine-btn").show()}}else if(Ibles.session.authenticated()){this.$(".flagComment").show()}if(this.model.get("author")===Ibles.pageContext.ibleData.author.screenName){this.$(".is-author").show();this.$(".comment").addClass("highlight")}if(this.model.get("author")===Ibles.session.get("screenName")){this.$(".deleteComment").show()}if(!this.model.get("fileSet").isEmpty()){this.renderFiles()}else{this.$(".comment-files,.comment-photos").hide()}if(this.model.get("IMadeIt")===true){this.$(".comment-author").addClass("imadeit");this.$(".imadeit-check").prop("checked",true);this.$(".made-it-header").show()}if(this.model.get("sticky")===true){this.$(".sticky-check").prop("checked",true)}if(this.model.get("approved")===true){this.$(".approved-check").prop("checked",true)}if(!_.isUndefined(this.model.get("inReplyTo"))&&_.isNull(this.model.get("replyAuthor"))){this.model.set({replyAuthor:this.model.collection.get(this.model.get("inReplyTo")).get("author")})}this.attachAuthorAchievements();this.attachStatsCard();this.attachCommentImagesFancybox();return this.$el},attachAuthorAchievements:function(){var self=this;var authorId=this.model.get("authorId");this.achievents.fetchForAuthor(authorId).done(function(authorStats){var achievementView=new Ibles.views.Achievement({model:new Backbone.Model(_.extend(authorStats,{authorId:authorId}))});self.$(".achievement-holder").html(achievementView.render().el);if(self.$(".author-achievements").is(":visible")){self.$(".imadeit").addClass("has-achievement")}})},attachStatsCard:function(){this.$(".memberstats").statscard({loginURL:"/account/login",screenName:this.model.get("author")})},renderFiles:function(){var imageTemplate=Ibles.templateCache("#template-image-file"),fileTemplate=Ibles.templateCache("#template-attached-file"),that=this;this.model.get("fileSet").each(function(file){file.set({commentId:that.model.get("id")});if(_.isUndefined(file.get("height"))){that.$(".comment-files").append(fileTemplate(file.toJSON()))}else{that.$(".comment-photos").append(imageTemplate(file.toJSON()))}})},renderReplyUI:function(e){e.preventDefault();if(Ibles.session.authenticated()){$(".comment-container .post-comment-container").remove();var reply=new Ibles.models.CommentModel({inReplyTo:this.model.get("id"),replyAuthor:this.model.get("author")}),replyView=new Ibles.views.ReplyPostingView({model:reply});this.$(".comment").after(replyView.render());$("html, body").animate({scrollTop:this.$el.offset().top},1e3)}else{$("#loginModal").modal("show")}},setIMadeItAction:function(e){var that=this;this.showRequestFeedback(this.model.setIMadeIt(this.$(".imadeit-check").is(":checked")))},deleteCommentAction:function(e){var response=confirm(Ibles.attemptTranslationOfString("Are you sure you want to delete this comment?"));if(response){this.showRequestFeedback(this.model.deleteComment())}},deleteThreadAction:function(){var response=confirm(Ibles.attemptTranslationOfString("Are you sure you want to delete this thread?"));if(response){this.showRequestFeedback(this.model.deleteThread())}},flagComment:function(e){this.showRequestFeedback(this.model.flagComment($(e.currentTarget).data("flagname")))},limboComment:function(e){this.showRequestFeedback(this.model.limbo())},unquarantineComment:function(e){this.showRequestFeedback(this.model.unquarantine())},toggleSticky:function(e){this.showRequestFeedback(this.model.toggleStickyComment($(e.currentTarget).prop("checked")))},toggleApproval:function(e){this.showRequestFeedback(this.model.toggleApproval($(e.currentTarget).prop("checked")))},showRequestFeedback:function(promise){var that=this;this.$(".request-img").show();promise.then(function(){that.$(".request-img").hide();that.$(".request-success").show();that.$(".request-success").fadeOut()}).fail(function(){that.$(".request-img").hide();that.$(".request-failure").show();that.$(".request-failure").fadeOut()})},scrollToParent:function(e){e.preventDefault();if(!_.isUndefined(this.model.get("inReplyTo"))){var $parent=$("#comment-"+this.model.get("inReplyTo")),scrollPos=$parent.offset().top-$("#ible-header.fixed").outerHeight();if(scrollPos<window.scrollTop){$("body,html").animate({scrollTop:scrollPos},"fast")}}},attachCommentImagesFancybox:function(){this.$(".comment-photos-link").fancybox()}});Ibles.views.BaseCommentPostingView=Backbone.View.extend({events:{"click .post-comment-btn":"sendComment","click .addCommentImages":"attemptUpload","click .comment-imadeit-toggle":"toggleIMadeIt"},render:function(){this.$el.html(this.template(this.model.toJSON()));this.addRedactorAirMode();this.files=this.$(".commentFiles");this.imagebucket=this.$(".instructable-image-bucket");this.imagebucket.hide();return this.$el},sendComment:function(e){e.preventDefault();var bodyText=this.$(".postCommentBody").val();this.model.set({body:bodyText.replace(/\n/g,"<br>")});if(!_.isEmpty(this.files.val())&&!this.model.get("IMadeIt")){this.showImadeItPrompt()}else{this.postComment()}},postComment:function(){this.model.postCommentAction().then(this.onSend)},showImadeItPrompt:function(){var self=this;new Ibles.views.ImadeItConfirmModal({model:this.model,selectionCallback:function(){self.postComment()}}).render()},showPostingError:function(model,options){var errorMessage=options["message"];this.$(".error-box").text(errorMessage).removeClass("hide")},toggleIMadeIt:function(e){},addRedactorAirMode:function(){var self=this;head.load("/static/drag_editor/dependencies/redactorInstructables/redactor_air_instructables.5.js",function(){loadRedactorAir(self.$(".redactorAirComment"),{callback:function(){var toolTip=self.$(".comment-tip");toolTip.tooltip();self.$(".redactor_redactorAirComment").on("click",function(){Ibles.authFlow.checkLoginThen(function(){toolTip.tooltip("show");setTimeout(function(){self.hideToolTip()},3e3)})})}})})},attemptUpload:function(e){e.preventDefault();var self=this;Ibles.authFlow.checkLoginThen(function(){self.showUploader()})},showUploader:function(){this.model.get("fileSet").bind("add remove",this.syncFileCommentFiles);var fileSetView=new window.ibles.InstructableFileSetView({collection:this.model.get("fileSet"),el:this.imagebucket,fileConstructor:window.ibles.CommentFileView});fileSetView.makeDroppable();this.uploader=new window.ibles.uploadModalView({collection:this.model.get("fileSet")});this.$(".fileset_placeholder_holder").hide()},syncFileCommentFiles:function(){this.files.val("");_.each(this.model.get("fileSet").models,function(file){this.addFileToInput(file)},this);if(this.model.get("fileSet").length>0){this.imagebucket.fadeIn()}else{this.imagebucket.fadeOut()}},addFileToInput:function(file){var files=this.files.val();if(files!==""){this.files.val(files+" "+file.get("id"))}else{this.files.val(file.get("id"))}return this},hideToolTip:function(){this.$(".comment-tip").tooltip("hide");this.$(".redactor_redactorAirComment").off("click")},showPostingError:function(errorMessage){var alert=new Ibles.models.AlertModel({alertType:"error",alertMessage:errorMessage});new Ibles.views.AlertLabelView({el:this.$(".comment-error"),model:alert})},showOrHideFileView:function(){if(this.model.get("fileSet").isEmpty()){this.imagebucket.hide()}else{this.imagebucket.show()}}});Ibles.views.ReplyPostingView=Ibles.views.BaseCommentPostingView.extend({initialize:function(){_.bindAll(this,"sendComment","onSend","syncFileCommentFiles");this.template=Ibles.templateCache("#template-post-comment");this.listenTo(this.model,"comment.postError",this.showPostingError);this.listenTo(this.model.get("fileSet"),"add remove",this.showOrHideFileview)},onSend:function(){this.$el.remove();window.Ibles.ACHIEVEMENTS.fetch()}});Ibles.views.CommentPostingView=Ibles.views.BaseCommentPostingView.extend({el:"#topLevelCommentField",initialize:function(){_.bindAll(this,"sendComment","onSend","syncFileCommentFiles");this.model=new Ibles.models.CommentModel;this.template=Ibles.templateCache("#top-level-post-comment");this.render();this.listenTo(this.model,"change:IMadeIt",this.updateIMadeItButton);this.listenTo(this.model.get("fileSet"),"add remove",this.showOrHideFileview);this.listenTo(this.model,"comment.postError",this.showPostingError)},toggleIMadeIt:function(e){var that=this;e.preventDefault();Ibles.authFlow.checkLoginThen(function(){that.model.set({IMadeIt:!that.model.get("IMadeIt")})})},updateIMadeItButton:function(){var that=this;if(this.model.get("IMadeIt")){this.$(".comment-imadeit-toggle").addClass("active");if(this.model.get("fileSet").isEmpty()){this.$(".imadeit-image-warning").show();this.$(".imadeit-image-warning button.close").click(function(e){that.$(".imadeit-image-warning").hide()})}}else{this.$(".comment-imadeit-toggle").removeClass("active")}},onSend:function(){this.undelegateEvents();this.$el.empty();this.stopListening();new Ibles.views.CommentPostingView}});Ibles.views.ImadeItConfirmModal=Backbone.View.extend({className:"imadeit-modal modal hide fade",model:null,events:{"click .imadeit-yes":"setImadeIt","click .imadeit-no":"unsetImadeIt"},initialize:function(options){this.selectionCallback=options&&options.selectionCallback;this.$el.html(Ibles.templateCache("#template-imadeit-modal"));$("body").append(this.$el)},setImadeIt:function(e){e.preventDefault();this.model.set({IMadeIt:true});this.afterToggle()},unsetImadeIt:function(e){e.preventDefault();this.model.set({IMadeIt:false});this.afterToggle()},afterToggle:function(){this.$el.modal("hide");if(_.isFunction(this.selectionCallback))this.selectionCallback()},render:function(){var self=this;this.$el.one("hidden.bs.modal",function(e){self.remove()});this.$el.modal("show")}});Ibles.package("Ibles.models");Ibles.models.InstructableModel=Backbone.Model.extend({defaults:{id:null,title:null,urlString:null,fullUrl:null,author:null,type:null,status:null,category:null,channel:null,publishDate:null,favorited:false,flagged:false},initialize:function(data){this.set({favorited:data.favorite,fullUrl:Ibles.pageContext.remoteRoot.slice(0,-1)+Ibles.reverseUrls.ibleUrl(this.get("urlString"))});this.getStats()},flagAction:function(){var self=this;return Ibles.API.ajaxRequest("flag",{entryID:this.get("id"),action:"SET",flag:this.get("flaggedAs")},{success:function(){self.set({flagged:true})}})},favoriteAction:function(){var self=this;return Ibles.API.ajaxRequest("favorite",{entryId:this.get("id")},{success:function(){self.set({favorited:!self.get("favorited")})}})},isFavorite:function(){var self=this;return Ibles.API.getRequest("isFavorite",{id:this.get("id")},{success:function(data){self.set({favorited:data["isFavorite"]})}})},getStats:function(){var that=this;return Ibles.API.getRequest("getIbleStats",{id:this.get("id")},{success:function(data){that.set(data)
}},["views","favorites","comments"])},toJSON:function(){var json=Backbone.Model.prototype.toJSON.apply(this,arguments);json.url=Ibles.reverseUrls.ibleUrl(json.id);return json}});Ibles.models.VotableContestModel=Backbone.Model.extend({defaults:{id:null,voted:false,ibleId:null},initialize:function(){this.listenTo(Ibles.session,"change:logged_in",this.getVotedState);this.getVotedState()},getVotedState:function(){var that=this;if(Ibles.session.authenticated()){Ibles.API.getRequest("getVotes",{id:this.get("id"),requested:(new Date).getTime()},{success:function(data){var foundEntry=_.find(data.votedEntries,function(entry){return entry.id===that.get("ibleId")});that.set({voted:!_.isUndefined(foundEntry)})}},"votedEntries")}else{this.set({voted:false})}},vote:function(onCompletion){var that=this;Ibles.API.contestAjaxRequest("vote",{contestId:this.get("id"),instructableId:this.get("ibleId"),posted:(new Date).getTime(),add:!this.get("voted")},{success:function(){that.set({voted:!that.get("voted")})},complete:function(){if(_.isFunction(onCompletion))onCompletion()}})}});Ibles.package("Ibles.models");Ibles.models.AuthorModel=Backbone.Model.extend({defaults:{screenName:null,following:false},followAction:function(){var method=this.get("following")?"unfollowAuthor":"followAuthor",screenName=this.get("screenName"),self=this;return Ibles.API.postRequest(method,{screenName:screenName},{success:function(response){if(response["message"].indexOf("You are now following")!=-1){self.set({following:true})}else if(response["message"].indexOf("You are no longer following")!=-1){self.set({following:false})}}})},isFollowing:function(){var self=this;return Ibles.API.getRequest("isFollowing",{screenName:this.get("screenName")},{success:function(data){self.set({following:data["isFollowing"]})}})}});Ibles.package("Ibles.views");Ibles.views.InstructableView=Backbone.View.extend({commentsManager:null,ibleModel:null,authorModel:null,session:null,events:{"click .favorite-btn":"attemptFave","click .follow-btn":"attemptFollow","click .share-btn":"toggledShareMenu","click #steps-nav-toggle":"toggleStepsNav","click .google-share-button":"shareOnGPlus","click .facebook-share-button":"shareOnFacebook","click .flag-as-btn":"attemptFlag","click .add-to-collection-btn":"showAddToCollectionModal","click #more-stats-btn":"showStatsModal","click #imadeit-btn":"scrollToCommentAndToggleImadeIt","click #add-to-contest-btn":"showAddToContestModal","click #add-to-group-btn":"showAddToGroupModal","click .view-all-steps-btn":"toggleAllSteps","click #print-it-btn":"printIt"},initialize:function(opts){this.session=Ibles.session;this.setupCommonSubviewsAndModels(opts);this.setupStickyAds(opts);this.setupPhotosets();this.setupAdminPanel();this.setupStickyHeader();this.setupVoting();this.setupPdfDownload();this.updateFollowingState();this.updateFavoriteState();this.setUpCategoryTracking();this.setupGtmDataLayer();this.createShareMenu();this.render()},setupPhotosets:function(){_.each(this.$(".photoset"),function($photoset){new PhotosetView({el:$photoset,maxRowsVisible:3,gutter:"5px",variableLayout:true})})},shouldShowAdminPanel:function(){var session=this.session;return session.isAdmin()||session.isStaff()||session.get("id")===this.authorModel.get("id")},setupAdminPanel:function(){if(this.shouldShowAdminPanel()){var adminTemplateRequest=$.ajax({url:Ibles.reverseUrls.adminTemplates(),success:function(templatesHTML){$(templatesHTML).appendTo("body");head.load(Ibles.assets.admin(),function(){new Ibles.views.Admin({el:"#admin-container"})})}})}},setupCommonSubviewsAndModels:function(opts){var ibleData=Ibles.pageContext.ibleData;this.allSteps=opts.allSteps;this.ibleModel=new Ibles.models.InstructableModel(ibleData);this.authorModel=new Ibles.models.AuthorModel(ibleData.author);this.listenTo(this.ibleModel,"change:favorited",this.render);this.listenTo(this.authorModel,"change:following",this.render);this.listenTo(this.ibleModel,"change:comments change:favorites change:views",this.updateStats);this.setupComments(opts)},setupStickyHeader:function(){new Ibles.views.StickyHeader({el:".sticky-header"})},setupStickyAds:function(opts){if(!opts||!opts.collection&&!opts.disableAds){if(!this.ibleModel.get("pgFlag")){new Ibles.views.StickyAdslot({el:"#ible-stickyad"})}}},setupComments:function(opts){var self=this;if(!opts||!opts.disableComments){sessionReady(function(session){if(!session.authenticated()){self.createCommentManager()}else{self.fetchUploaderTemplates(function(){self.fetchUploaderScripts(_.bind(self.createCommentManager,self))})}})}},createCommentManager:function(){this.commentsManager=new Ibles.views.CommentManager;this.listenToOnce(this.commentsManager,"commentsRendered",_.bind(this.scrollToComment,this))},scrollToComment:function(){if(Ibles.Q("comments")==="all"){var hash=window.location.hash,commentId=hash&&hash.substr(1),commentContainer=commentId&&this.$("#comment-{0}".format(commentId)),commentsContainer=this.$("#comment-list"),scrollTop;if(commentContainer.length){scrollTop=commentContainer.offset().top}else{scrollTop=commentsContainer.offset().top}$("html, body").animate({scrollTop:scrollTop},1e3)}},setupVoting:function(){new Ibles.views.VotingDropdownMenu({el:"#vote-dropdown",votableContests:Ibles.pageContext.ibleData.votableContests,ibleId:this.ibleModel.get("id")})},setupPdfDownload:function(){new Ibles.views.PDFDownloadView({el:"#pdf-content"})},updateFollowingState:function(){if(this.session.authenticated()){this.authorModel.isFollowing()}},updateFavoriteState:function(){if(this.session.authenticated()){this.ibleModel.isFavorite()}},shareOnGPlus:function(e){e.preventDefault();window.open($(e.currentTarget).attr("href"),"","menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600");return false},shareOnFacebook:function(e){if(!_.isUndefined(FB)){e.preventDefault();FB.ui({method:"share",href:this.ibleModel.get("fullUrl")})}},createShareMenu:function(){new Ibles.views.IbleShareMenuView({model:this.ibleModel})},toggleStepsNav:function(e){e.preventDefault();var $ibleHeader=$("#ible-header"),$ibleStepsNav=$("#ible-steps-nav"),$toggleBtn=$("#steps-nav-toggle");$toggleBtn.toggleClass("active");$ibleStepsNav.toggleClass("expanded");$ibleHeader.parent().height($ibleHeader.outerHeight())},attemptFave:function(e){e.preventDefault();if(this.session.authenticated()){Ibles.alertWhenError(this.ibleModel.favoriteAction())}else{Ibles.authFlow.showLogin(e)}},attemptFollow:function(e){if(this.session.authenticated()){Ibles.alertWhenError(this.authorModel.followAction())}else{Ibles.authFlow.showLogin(e)}},attemptFlag:function(e){e.preventDefault();var ibleMod=this.ibleModel;Ibles.authFlow.checkLoginThen(function(){var target=$(e.target);var reasonText=target.text();var reason=target.attr("data-flag-as");new Ibles.views.ConfirmationView({model:new Ibles.models.ConfirmationModel({confirmationMessage:Ibles.attemptTranslationOfString(Ibles.locale.messages.confirmFlag.replace("<< reason >>",reasonText))}),callbackFn:function(){ibleMod.set("flaggedAs",reason);ibleMod.flagAction().success(Ibles.views.AlertView.callbackFactory("success")).error(Ibles.views.AlertView.callbackFactory("error"))}})})},showAddToCollectionModal:function(e){var self=this;Ibles.authFlow.checkLoginThen(function(){head.load(Ibles.assets.manageCollectionAssets(),$.proxy(self.renderAddToCollectionModal,self))})},renderAddToCollectionModal:function(){var self=this;if(!this.addToCollectionView){var $addBtn=$(".add-to-collection-btn");$addBtn.addClass("loading");var ible=Ibles.pageContext.ibleData;this.addToCollectionView=new Ibles.views.AddToCollectionView({ibleId:ible.id,ibleTitle:ible.title,ibleThumbUrl:ible.rectangle1Url});this.listenToOnce(this.addToCollectionView,"ready",function(){$addBtn.removeClass("loading")})}this.addToCollectionView.render()},showStatsModal:function(){var self=this;Ibles.authFlow.checkLoginThen(function(){head.load(Ibles.assets.analytics().concat("https://apis.google.com/js/platform.js"),function(){gapi.load("analytics",$.proxy(self.renderStatsModal,self))})})},renderStatsModal:function(){var self=this;if(!this.analyticsView){this.analyticsView=new Ibles.views.AnalyticsView({model:new Ibles.models.StatsModel(_.pick(self.ibleModel.attributes,"id","urlString","title","comments","favorites","views"))})}this.analyticsView.render()},showAddToContestModal:function(){var self=this;if(!this.addToContestView){this.addToContestView=new Ibles.views.AddToContestView({ibleData:Ibles.pageContext.ibleData})}this.addToContestView.render()},showAddToGroupModal:function(){var self=this;if(!this.addToGroupView){this.addToGroupView=new Ibles.views.AddToGroupView({ibleData:Ibles.pageContext.ibleData})}this.addToGroupView.render()},toggleAllSteps:function(e){e.preventDefault();var target=$(e.currentTarget),allstepsActive=target.hasClass("active"),ibleUrl=Ibles.reverseUrls.ibleUrl(Ibles.pageContext.ibleData.urlString);if(!this.session.authenticated()){window.location=allstepsActive?ibleUrl:"{0}?ALLSTEPS".format(ibleUrl)}else{document.cookie=allstepsActive?"ibleAllSteps=0; path=/":"ibleAllSteps=1; path=/";window.location=ibleUrl}},isViewedByAuthor:function(){return this.session.authenticated()&&this.session.get("screenName")===this.authorModel.get("screenName")},render:function(){var loggedIn=this.session.authenticated(),isAdmin=loggedIn&&this.session.isAdmin(),isIbleAuthor=this.isViewedByAuthor(),isFavorite=this.ibleModel.get("favorited"),isFollowingAuthor=this.authorModel.get("following");if(isFavorite){$(".favorite-btn").addClass("active");$(".fave-btn-txt").html("Favorited")}else{$(".favorite-btn").removeClass("active");$(".fave-btn-txt").html("Favorite")}$(".follow-btn").html(isFollowingAuthor?"Following":"Follow");if(isAdmin||isIbleAuthor)$(".author-action").removeClass("hide");if(loggedIn)this.$("#add-ible-section").show();this.updateSidebar()},updateSidebar:function(){if(this.ibleModel.get("type")!=="Guide"){if(this.isViewedByAuthor()||this.session.isAdmin()){this.$(".publish-date").html(Ibles.templateCache("#posted-date")(this.ibleModel.toJSON()))}if(this.session.isAdmin()||this.session.isStaff()){if(this.ibleModel.get("featureFlag")===true&&!_.isUndefined(this.ibleModel.get("featuredBy"))){this.$(".featured-by").html(Ibles.templateCache("#featured-by")(this.ibleModel.toJSON()))}}}},updateStats:function(){this.$(".comment-number").html(this.ibleModel.get("comments").toLocaleString());this.$(".favorite-count").html(this.ibleModel.get("favorites").toLocaleString());this.$(".view-count").html(this.ibleModel.get("views").toLocaleString())},fetchUploaderTemplates:function(callback){var loadTemplate=function(templateUrl){return $.ajax({url:templateUrl,success:function(data){$("body").append(data)}})};$.when(loadTemplate("/static/drag_editor/html/js_uploaderTemplates.html"),loadTemplate("/static/drag_editor/html/uploader_prod.html")).done(callback)},fetchUploaderScripts:function(callback){var applyRemotePrefix=function(staticPath){return Ibles.pageContext.remoteRoot+"static/drag_editor/"+staticPath};var uploaderCss=_.map(["dependencies/uploader_depends/jquery-ui-1.10.4.custom/css/ui-lightness/jquery-ui-1.10.4.custom.min.css"],applyRemotePrefix);var uploaderScripts=_.map(["dependencies/uploader_depends/jquery-ui-1.10.4.custom/js/jquery-ui-1.10.4.custom.min.js","js/editor_locale_en_US.js"],applyRemotePrefix).concat(Ibles.pageContext.remoteRoot+window.UPLOAD_SCRIPT.substr(1));head.load(uploaderCss);head.load(uploaderScripts,callback)},scrollToCommentAndToggleImadeIt:function(){Ibles.authFlow.checkLoginThen(function(){var commentBoxContainer=$("#topLevelCommentField"),commentIMadeItButton=commentBoxContainer.find(".comment-imadeit-toggle"),topSpacing=10;$(window).scrollTop(commentBoxContainer.offset().top-$("#ible-header").outerHeight()-topSpacing);if(!commentIMadeItButton.hasClass("active")){commentIMadeItButton.click()}})},setUpCategoryTracking:function(){var categoryCounts={},channelCounts={},category=Ibles.pageContext.ibleData.category,channel=Ibles.pageContext.ibleData.channel;if(_.isUndefined($.cookie("categoryTimer"))){var expiry=moment().add(30,"m"),path=Ibles.reverseUrls.ibleUrl(Ibles.pageContext.ibleData.urlString).replace(/\?lang=\w+$/,"");$.cookie("categoryTimer",Ibles.pageContext.ibleData.id,{path:path,expires:expiry.toDate()});try{if(!_.isUndefined(localStorage["ibleCategories"])){categoryCounts=JSON.parse(localStorage["ibleCategories"])}if(_.isUndefined(categoryCounts[category])){categoryCounts[category]=1}else{categoryCounts[category]=categoryCounts[category]+1}localStorage["ibleCategories"]=JSON.stringify(categoryCounts);if(!_.isUndefined(channel)){if(!_.isUndefined(localStorage["ibleChannels"])){channelCounts=JSON.parse(localStorage["ibleChannels"])}if(_.isUndefined(channelCounts[channel])){channelCounts[channel]=1}else{channelCounts[channel]=channelCounts[channel]+1}localStorage["ibleChannels"]=JSON.stringify(channelCounts)}}catch(e){try{localStorage.clear()}catch(clearError){}}}},setupGtmDataLayer:function(){if(window.dataLayer){window.dataLayer.push({category:this.ibleModel.get("category"),channel:this.ibleModel.get("channel")})}},printIt:function(e){e.preventDefault();head.load(Ibles.staticUrl("js/Ibles/PrintIt.js"),function(){var currentTarget=$(e.target),filename=currentTarget.attr("data-filename"),fileUrl=currentTarget.attr("data-fileurl"),modal=new Ibles.views.PrintItView({model:new Ibles.models.PrintItModel({filename:filename,fileUrl:Ibles.getLocation(fileUrl).pathname})});$("body").append(modal.render())})}});Ibles.views.StickyHeader=Backbone.View.extend({events:{"click .sticky-header-toggle":"toggleHeader"},initialize:function(){this.makeHeaderSticky();this.setupScrollAdjust()},toggleHeader:function(e){var $header=this.$el,$headerInner=this.$(".sticky-header-inner"),$headerToggle=this.$(".sticky-header-inner"),headerState=$.cookie("stickyHeaderCollapsed")==1?"collapsed":"expanded",visible=$headerInner.is(":visible");e.preventDefault();document.cookie=visible?"stickyHeaderCollapsed=1; path=/":"stickyHeaderCollapsed=0; path=/";if(visible){$headerInner.slideUp("fast",function(){$header.removeClass("expanded").addClass("collapsed")})}else{$headerInner.slideDown("fast",function(){$header.removeClass("collapsed").addClass("expanded")})}},setupScrollAdjust:function(){var self=this;document.body.addEventListener("keydown",function(event){self.scrollAdjustCallback(event)},false)},scrollAdjustCallback:function(event){var $header=this.$el;if((event.keyCode==32||event.keyCode==34)&&!event.shiftKey){if(document.activeElement.tagName=="BODY"){event.preventDefault();$("html, body").filter(":not(:animated)").animate({scrollTop:$(window).scrollTop()+$(window).height()-($header.hasClass("expanded")?$header.parent().height():0)},"fast")}else if(event.keyCode==34){event.preventDefault()}}},makeHeaderSticky:function(){var self=this;$(window).bind("scroll",function(){self.pinOrUnpinHeader()})},pinOrUnpinHeader:function(){var $header=this.$el,$headerInner=this.$(".sticky-header-inner"),scrollTop=$(window).scrollTop(),headerOffsetTop=$header.parent().offset().top,headerOffsetBottom=headerOffsetTop+$header.height(),headerState=$.cookie("stickyHeaderCollapsed")==1?"collapsed":"expanded",headerCollapsed=($header.hasClass("collapsed")||headerState=="collapsed")&&!$header.hasClass("expanded"),headerPinOffset=headerCollapsed?headerOffsetBottom:headerOffsetTop;if(scrollTop>headerPinOffset){this.pinHeader(headerState);if(headerCollapsed)$headerInner.hide()}else{this.unpinHeader(headerState);if(headerCollapsed)$headerInner.show()}},pinHeader:function(headerState){var $header=this.$el,$headerToggle=this.$(".sticky-header-toggle");if(!this.alreadyPinned){this.alreadyPinned=true;$header.parent().height($header.outerHeight());$header.addClass("fixed "+headerState);$headerToggle.show()}},unpinHeader:function(headerState){var header=this.$el,headerToggle=this.$(".sticky-header-toggle");header.removeClass("fixed "+headerState);headerToggle.hide();this.alreadyPinned=false}});Ibles.views.StickyAdslot=Backbone.View.extend({initialize:function(opts){var self=this;this.updateStickyAdTop=true;this.stickyAdTop=this.$el.offset().top;$(window).bind("scroll",function(){self.pinOrUnpinSidebarAd()})},pinOrUnpinSidebarAd:function(){var $win=$(window),$wrapper=$("#instructable-container"),$mainContent=$("#instructable-content"),$sidebar=$("#instructable-sidebar"),$ibleHeader=$("#ible-header"),$stickyAd=$("#ible-stickyad"),padding=22,stickyAdHeight=$stickyAd.height();scrollTop=$win.scrollTop(),sidebarHeight=$sidebar.height(),sidebarBottomOffset=sidebarHeight+$sidebar.offset().top,mainContentHeight=$mainContent.height(),mainContentBottomOffset=mainContentHeight+$mainContent.offset().top,topAdjust=$ibleHeader.outerHeight()+padding;if(this.updateStickyAdTop)this.stickyAdTop=$stickyAd.offset().top;$stickyAd.parent().height(stickyAdHeight);if(sidebarHeight<mainContentHeight){if(scrollTop+stickyAdHeight>mainContentBottomOffset-topAdjust){$stickyAd.css({top:"auto",position:"absolute",bottom:0,left:"auto"});this.updateStickyAdTop=false}else if(scrollTop>this.stickyAdTop-topAdjust){if($win.width()<$wrapper.width()){$stickyAd.css({top:topAdjust+"px",bottom:"auto",position:"fixed",left:$sidebar.offset().left-$win.scrollLeft()})}else{$stickyAd.css({top:topAdjust+"px",bottom:"auto",position:"fixed",left:"auto"})}this.updateStickyAdTop=false}else{$stickyAd.css({top:"auto",bottom:"auto",left:"auto",position:"relative"});this.updateStickyAdTop=true}}}});Ibles.views.VotingDropdownMenu=Backbone.View.extend({events:{"click #vote-dropdown-toggle":"toggleVoteDropdown","click .vote-toggle-btn":"toggleVote"},initialize:function(opts){this.ibleId=opts.ibleId;this.votableContests=opts.votableContests},populateAndRenderMenu:function(){var self=this;this.template=Ibles.templateCache("#template-vote-menu");this.votableContestCollection=new Backbone.Collection([],{model:Ibles.models.VotableContestModel});_.each(this.votableContests,function(contest){contest.ibleId=self.ibleId;contest.thumbUrl=contest.thumbUrl.replace("THUMB","SQUARE2");contest.url=Ibles.reverseUrls.contestDetailUrl(contest.urlString);var model=new Ibles.models.VotableContestModel(contest);self.votableContestCollection.add(model);self.listenTo(model,"change:voted",self.updateVote)});this.render()},updateVote:function(model){var $contestBtn=this.$("li[data-contestid='"+model.get("id")+"']").find(".btn");if(model.get("voted")){$contestBtn.addClass("active")}else{$contestBtn.removeClass("active")}},toggleVoteDropdown:function(e){e.preventDefault();if(this.$("#vote-dropdown").hasClass("open")){this.hideVoteDropdown()}else{this.showVoteDropdown()}},hideVoteDropdown:function(){this.$el.removeClass("open");$("html").off("click.vote-dropdown")},showVoteDropdown:function(){var self=this;this.$el.addClass("open");if(!this.menuContentPopulated){this.populateAndRenderMenu();this.menuContentPopulated=true}$("html").on("click.vote-dropdown",function(e){var target=$(e.target);if(target.closest("#vote-dropdown").length==0){self.hideVoteDropdown()}})},toggleVote:function(e){var self=this;e.preventDefault();Ibles.authFlow.checkLoginThen(function(){var $btn=$(e.currentTarget),$btnLabel=$btn.find(".vote-text"),contestId=$btn.closest("li").data("contestid"),contestModel=self.votableContestCollection.get(contestId);if(!$btn.hasClass("loading")){$btn.addClass("loading");$btnLabel.html($btn.data("loadingtxt"));contestModel.vote(function(){$btn.removeClass("loading");$btnLabel.html($btn.data("votetxt"))})}})},render:function(){this.$el.append(this.template({contests:this.votableContestCollection.toJSON()}));return this}});Ibles.views.PDFDownloadView=Backbone.View.extend({events:{"click #custom-pdf-download-btn":"submitCustomPdfOptions","click #includeImages":"toggleImageSizeOptions"},initialize:function(opts){if(Ibles.session.isPro()||Ibles.session.isOld()||Ibles.session.isAdmin()){this.$(".pdf-download-available").show()}else{this.$(".pdf-download-unavailable").show()}},toggleImageSizeOptions:function(){this.$(".image-sizes").toggle()},submitCustomPdfOptions:function(){var $form=this.$(".pdf-options-form");_.each(this.$(".pdf-options-form .checkbox input"),function(checkbox){var $checkbox=$(checkbox);if(!$checkbox.attr("checked")){$form.append($("<input/>",{type:"hidden",name:$checkbox.attr("name"),value:"off"}))}});_.each(this.$('input[name="includeStepsIds"]'),function(stepInput){var $stepInput=$(stepInput);if(!$stepInput.attr("checked")){$form.append($("<input/>",{type:"hidden",name:"excludeStepsIds",value:$stepInput.attr("value")}))}});$form.submit()}});Ibles.views.MobileInstructableView=Ibles.views.InstructableView.extend({events:{"click .favorite-btn":"attemptFave","click .follow-btn":"attemptFollow","click .google-share-button":"shareOnGPlus","click .facebook-share-button":"shareOnFacebook","click .vote-btn":"toggleVoteDrawer","click .flag-btn":"attemptFlag","click .social-controls-vote":"scrollAndVote","click .ible-social-menu .vote-btn":"scrollAndVote","click #full-instructable-button":"setPagePosCookie","click .show-more-images":"showMoreImages","click .test-feature":"showNotImplemented"},initialize:function(opts){this.session=Ibles.session;this.setupCommonSubviewsAndModels(opts);this.setupVoting();this.setupFlagger();this.updateFollowingState();this.updateFavoriteState();this.setUpCategoryTracking();this.setupGtmDataLayer();this.render();this.scrollToAllStepsStart();Ibles.lazyLoadImages($(".lazy-img"))},scrollToAllStepsStart:function(){if(!_.isUndefined($.cookie("pagePos"))&&!_.isUndefined($.cookie("ibleId"))){if(this.allSteps&&$.cookie("ibleId")===this.ibleModel.get("id")){$(document).scrollTop($.cookie("pagePos"))}$.removeCookie("ibleId",{path:"/"});$.removeCookie("pagePos",{path:"/"})}},setPagePosCookie:function(e){e.preventDefault();e.stopPropagation();$.cookie("pagePos",$(document).scrollTop(),{path:"/"});$.cookie("ibleId",this.ibleModel.get("id"),{path:"/"});var currentAllstepsClickCount=parseInt($.cookie("viewAllStepsClickCount")||0);$.cookie("viewAllStepsClickCount",currentAllstepsClickCount+1,{path:"/"});window.location=$(e.currentTarget).attr("href")},setupComments:function(opts){var self=this;if(!opts||!opts.disableComments){sessionReady(function(){self.commentsManager=new Ibles.views.MobileCommentManager})}},setupVoting:function(){var votableContests=Ibles.pageContext.ibleData.votableContests,that=this;if(!_.isEmpty(votableContests)){this.$(".vote-toggle").addClass("vote-active");_.each(votableContests,function(contest){contest.ibleId=that.ibleModel.get("id");var contestView=new Ibles.views.MobileVotableContestView({model:new Ibles.models.VotableContestModel(contest)});$("#vote-drawer").prepend(contestView.render())})}},updateSidebar:function(){},setupFlagger:function(){var flagger,data=_.pick(Ibles.pageContext.ibleData,"id","featured","typeChar","status");data.destUrl=window.location.pathname;data.type="INSTRUCTABLE";flagger=new Ibles.models.FlaggerModel(data);new Ibles.views.IbleFlaggerView({model:flagger,el:"#flag-drawer"})},attemptFlag:function(e){e.preventDefault();if(Ibles.session.authenticated()){if($("#flag-drawer").is(":visible")){$("#flag-drawer").slideUp()}else{$(".header-drawer").hide();$("#flag-drawer").slideDown()}}},toggleVoteDrawer:function(e){e.preventDefault();if($("#vote-drawer").is(":visible")){$("#vote-drawer").slideUp()}else{$(".header-drawer").hide();$("#vote-drawer").slideDown()}},showVoteDrawer:function(e){e.preventDefault();if(!$("#vote-drawer").is(":visible")){$(".header-drawer").hide();$("#vote-drawer").slideDown()}},scrollAndVote:function(e){e.preventDefault();var that=this;$("html, body").animate({scrollTop:$(".vote-btn.mobile-ible-header-controls-btn").offset().top},1e3,_.debounce(function(){that.showVoteDrawer(e)},50))},showMoreImages:function(e){e.preventDefault();var trigger=$(e.currentTarget);trigger.hide();trigger.closest(".mobile-step-files").find(".mobile-file-photo").removeClass("hide");$("html, body").animate({scrollTop:$(window).scrollTop()+100})},showNotImplemented:function(e){e.preventDefault();new Ibles.views.ComingSoonView},updateStats:function(){this.$(".comment-number").html(Ibles.formatNumber(this.ibleModel.get("comments")));this.$(".favorite-count").html(Ibles.formatNumber(this.ibleModel.get("favorites")));this.$(".view-count").html(Ibles.formatNumber(this.ibleModel.get("views")))}});Ibles.views.MobileVotableContestView=Backbone.View.extend({className:"votable-contest",events:{"click .vote-toggle-link":"voteAction"},initialize:function(){this.template=_.template($("#votableContestTemplate").html());this.listenTo(this.model,"change:voted",this.updateVote)},voteAction:function(e){e.preventDefault();if(!this.$el.hasClass("loading")&&Ibles.session.authenticated()){this.$el.addClass("loading");var that=this;this.model.vote(function(){that.$el.removeClass("loading")})}},updateVote:function(){if(this.model.get("voted")){this.$(".vote-toggle-link").addClass("active")}else{this.$(".vote-toggle-link").removeClass("active")}},render:function(){this.$el.html(this.template(this.model.toJSON()));return this.$el}});Ibles.views.ComingSoonView=Backbone.View.extend({id:"coming-soon-modal",events:{"click .ok.btn":"closeModal"},initialize:function(){this.template=Ibles.templateCache("#coming-soon-modal-template");this.render()},closeModal:function(){this.$el.find(".coming-soon-modal").modal("hide")},render:function(){var that=this;this.$el.append(this.template(this.data));$("body").append(this.$el);this.$el.find(".coming-soon-modal").modal("show").on("hidden.bs.modal",function(){that.remove.call(that)})},remove:function(){this.$el.remove()}});Ibles.package("Ibles.views");Ibles.views.IbleShareMenuView=Backbone.View.extend({el:".share-menu",initialize:function(){this.template=Ibles.templateCache("#share-ible-menu-template");this.render()},render:function(){var JSON=this.model.toJSON();JSON.fullUrl=encodeURIComponent(JSON.fullUrl);JSON.title=encodeURIComponent(JSON.title);this.$el.html(this.template(JSON));return this.$el}});Ibles.package("Ibles.views","Ibles.models");Ibles.models.Achievements=Backbone.Model.extend({deferred:null,authorIds:[],initialize:function(options){var self=this;this.deferred=$.Deferred();if(options&&options.authorIds){this.authorIds=options.authorIds}},addAuthor:function(authorId){this.authorIds.push(authorId)},clearAuthors:function(){this.set({authorIds:[]})},fetch:function(){var self=this;if(this.authorIds&&this.authorIds.length){Ibles.API.getRequest("getAuthorsStats",_.map(this.authorIds,function(authorId){return{name:"id",value:authorId}}),{success:function(data){self.set(data);self.deferred.resolve(data)},error:function(){self.deferred.reject()}})}},fetchForAuthor:function(authorId){var deferred=$.Deferred(),self=this;this.deferred.done(function(data){var authorStats=data["authorsStats"];if(authorStats.hasOwnProperty(authorId)){deferred.resolve(authorStats[authorId])}else{deferred.resolve({})}}).fail(function(){deferred.reject({})});return deferred.promise()}});Ibles.views.Achievement=Backbone.View.extend({achievementCriteria:{views:{bronze:1e4,silver:1e6,gold:1e7},comments:{bronze:100,silver:500,gold:1e3},featured:{bronze:1,silver:10,gold:100}},className:"author-achievements",attributes:function(){return{"data-toggle":"popover",style:"display:none"}},initialize:function(){this.template=_.template($("#template-achievement").html())},render:function(){this.$el.html(this.template());this.renderAchievements();return this},renderAchievements:function(){var properties={views:this.model.get("totalInstructableViews")+this.model.get("totalGuidesViews"),featured:this.model.get("featuredInstructablesCount")+this.model.get("featuredGuideCount"),comments:this.model.get("numCommentsMade")},authorId=this.model.get("authorId"),self=this;for(var key in properties){if(properties.hasOwnProperty(key)){self.addAchievement(authorId,key,properties[key])}}this.$el.popover({container:"body",placement:"top",trigger:"hover",html:true,content:this.$(".achievement-popover-wrapper").html(),template:'<div class="popover achievement-popover"><div class="arrow"></div><h3 class="popover-title"></h3><div class="popover-content"></div></div>'})},addAchievement:function(authorId,achievementType,authorStatProperty){var achievementCriteria=this.achievementCriteria;if(authorStatProperty>=achievementCriteria[achievementType].gold){this.renderMedallion("gold",achievementType)}else if(authorStatProperty>=achievementCriteria[achievementType].silver){this.renderMedallion("silver",achievementType)}else if(authorStatProperty>=achievementCriteria[achievementType].bronze){this.renderMedallion("bronze",achievementType)}},renderMedallion:function(medalType,achievementType){var $achievementWrapper=this.$el,$achievementIcon=$achievementWrapper.find(".achievement-"+achievementType),$achievementPopoverWrapper=$achievementWrapper.find(".achievement-popover-wrapper"),$achievementPopoverCoinWrapper=$achievementPopoverWrapper.find(".coin-"+achievementType+"-wrapper"),$achievementCoinIcon=$achievementPopoverWrapper.find("i.achievement-coin-"+achievementType);if(medalType==="gold"||medalType==="silver"||medalType==="bronze"){$achievementIcon.addClass("coin-"+medalType).show();$achievementCoinIcon.addClass("coin-"+achievementType+"-"+medalType);$achievementPopoverCoinWrapper.find("p").addClass("coin-"+medalType).text(medalType+" Medal");$achievementPopoverCoinWrapper.css("display","inline-block");if($achievementWrapper.is(":hidden"))$achievementWrapper.show()}}});(function(){function a(a){this._value=a}function b(a,b,c,d){var e,f,g=Math.pow(10,b);return f=(c(a*g)/g).toFixed(b),d&&(e=new RegExp("0{1,"+d+"}$"),f=f.replace(e,"")),f}function c(a,b,c){var d;return d=b.indexOf("$")>-1?e(a,b,c):b.indexOf("%")>-1?f(a,b,c):b.indexOf(":")>-1?g(a,b):i(a._value,b,c)}function d(a,b){var c,d,e,f,g,i=b,j=["KB","MB","GB","TB","PB","EB","ZB","YB"],k=!1;if(b.indexOf(":")>-1)a._value=h(b);else if(b===q)a._value=0;else{for("."!==o[p].delimiters.decimal&&(b=b.replace(/\./g,"").replace(o[p].delimiters.decimal,".")),c=new RegExp("[^a-zA-Z]"+o[p].abbreviations.thousand+"(?:\\)|(\\"+o[p].currency.symbol+")?(?:\\))?)?$"),d=new RegExp("[^a-zA-Z]"+o[p].abbreviations.million+"(?:\\)|(\\"+o[p].currency.symbol+")?(?:\\))?)?$"),e=new RegExp("[^a-zA-Z]"+o[p].abbreviations.billion+"(?:\\)|(\\"+o[p].currency.symbol+")?(?:\\))?)?$"),f=new RegExp("[^a-zA-Z]"+o[p].abbreviations.trillion+"(?:\\)|(\\"+o[p].currency.symbol+")?(?:\\))?)?$"),g=0;g<=j.length&&!(k=b.indexOf(j[g])>-1?Math.pow(1024,g+1):!1);g++);a._value=(k?k:1)*(i.match(c)?Math.pow(10,3):1)*(i.match(d)?Math.pow(10,6):1)*(i.match(e)?Math.pow(10,9):1)*(i.match(f)?Math.pow(10,12):1)*(b.indexOf("%")>-1?.01:1)*((b.split("-").length+Math.min(b.split("(").length-1,b.split(")").length-1))%2?1:-1)*Number(b.replace(/[^0-9\.]+/g,"")),a._value=k?Math.ceil(a._value):a._value}return a._value}function e(a,b,c){var d,e,f=b.indexOf("$"),g=b.indexOf("("),h=b.indexOf("-"),j="";return b.indexOf(" $")>-1?(j=" ",b=b.replace(" $","")):b.indexOf("$ ")>-1?(j=" ",b=b.replace("$ ","")):b=b.replace("$",""),e=i(a._value,b,c),1>=f?e.indexOf("(")>-1||e.indexOf("-")>-1?(e=e.split(""),d=1,(g>f||h>f)&&(d=0),e.splice(d,0,o[p].currency.symbol+j),e=e.join("")):e=o[p].currency.symbol+j+e:e.indexOf(")")>-1?(e=e.split(""),e.splice(-1,0,j+o[p].currency.symbol),e=e.join("")):e=e+j+o[p].currency.symbol,e}function f(a,b,c){var d,e="",f=100*a._value;return b.indexOf(" %")>-1?(e=" ",b=b.replace(" %","")):b=b.replace("%",""),d=i(f,b,c),d.indexOf(")")>-1?(d=d.split(""),d.splice(-1,0,e+"%"),d=d.join("")):d=d+e+"%",d}function g(a){var b=Math.floor(a._value/60/60),c=Math.floor((a._value-60*b*60)/60),d=Math.round(a._value-60*b*60-60*c);return b+":"+(10>c?"0"+c:c)+":"+(10>d?"0"+d:d)}function h(a){var b=a.split(":"),c=0;return 3===b.length?(c+=60*Number(b[0])*60,c+=60*Number(b[1]),c+=Number(b[2])):2===b.length&&(c+=60*Number(b[0]),c+=Number(b[1])),Number(c)}function i(a,c,d){var e,f,g,h,i,j,k=!1,l=!1,m=!1,n="",r=!1,s=!1,t=!1,u=!1,v=!1,w="",x="",y=Math.abs(a),z=["B","KB","MB","GB","TB","PB","EB","ZB","YB"],A="",B=!1;
if(0===a&&null!==q)return q;if(c.indexOf("(")>-1?(k=!0,c=c.slice(1,-1)):c.indexOf("+")>-1&&(l=!0,c=c.replace(/\+/g,"")),c.indexOf("a")>-1&&(r=c.indexOf("aK")>=0,s=c.indexOf("aM")>=0,t=c.indexOf("aB")>=0,u=c.indexOf("aT")>=0,v=r||s||t||u,c.indexOf(" a")>-1?(n=" ",c=c.replace(" a","")):c=c.replace("a",""),y>=Math.pow(10,12)&&!v||u?(n+=o[p].abbreviations.trillion,a/=Math.pow(10,12)):y<Math.pow(10,12)&&y>=Math.pow(10,9)&&!v||t?(n+=o[p].abbreviations.billion,a/=Math.pow(10,9)):y<Math.pow(10,9)&&y>=Math.pow(10,6)&&!v||s?(n+=o[p].abbreviations.million,a/=Math.pow(10,6)):(y<Math.pow(10,6)&&y>=Math.pow(10,3)&&!v||r)&&(n+=o[p].abbreviations.thousand,a/=Math.pow(10,3))),c.indexOf("b")>-1)for(c.indexOf(" b")>-1?(w=" ",c=c.replace(" b","")):c=c.replace("b",""),g=0;g<=z.length;g++)if(e=Math.pow(1024,g),f=Math.pow(1024,g+1),a>=e&&f>a){w+=z[g],e>0&&(a/=e);break}return c.indexOf("o")>-1&&(c.indexOf(" o")>-1?(x=" ",c=c.replace(" o","")):c=c.replace("o",""),x+=o[p].ordinal(a)),c.indexOf("[.]")>-1&&(m=!0,c=c.replace("[.]",".")),h=a.toString().split(".")[0],i=c.split(".")[1],j=c.indexOf(","),i?(i.indexOf("[")>-1?(i=i.replace("]",""),i=i.split("["),A=b(a,i[0].length+i[1].length,d,i[1].length)):A=b(a,i.length,d),h=A.split(".")[0],A=A.split(".")[1].length?o[p].delimiters.decimal+A.split(".")[1]:"",m&&0===Number(A.slice(1))&&(A="")):h=b(a,null,d),h.indexOf("-")>-1&&(h=h.slice(1),B=!0),j>-1&&(h=h.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g,"$1"+o[p].delimiters.thousands)),0===c.indexOf(".")&&(h=""),(k&&B?"(":"")+(!k&&B?"-":"")+(!B&&l?"+":"")+h+A+(x?x:"")+(n?n:"")+(w?w:"")+(k&&B?")":"")}function j(a,b){o[a]=b}function k(a){var b=a.toString().split(".");return b.length<2?1:Math.pow(10,b[1].length)}function l(){var a=Array.prototype.slice.call(arguments);return a.reduce(function(a,b){var c=k(a),d=k(b);return c>d?c:d},-1/0)}var m,n="1.5.3",o={},p="en",q=null,r="0,0",s="undefined"!=typeof module&&module.exports;m=function(b){return m.isNumeral(b)?b=b.value():0===b||"undefined"==typeof b?b=0:Number(b)||(b=m.fn.unformat(b)),new a(Number(b))},m.version=n,m.isNumeral=function(b){return b instanceof a},m.language=function(a,b){if(!a)return p;if(a&&!b){if(!o[a])throw new Error("Unknown language : "+a);p=a}return(b||!o[a])&&j(a,b),m},m.languageData=function(a){if(!a)return o[p];if(!o[a])throw new Error("Unknown language : "+a);return o[a]},m.language("en",{delimiters:{thousands:",",decimal:"."},abbreviations:{thousand:"k",million:"m",billion:"b",trillion:"t"},ordinal:function(a){var b=a%10;return 1===~~(a%100/10)?"th":1===b?"st":2===b?"nd":3===b?"rd":"th"},currency:{symbol:"$"}}),m.zeroFormat=function(a){q="string"==typeof a?a:null},m.defaultFormat=function(a){r="string"==typeof a?a:"0.0"},"function"!=typeof Array.prototype.reduce&&(Array.prototype.reduce=function(a,b){"use strict";if(null===this||"undefined"==typeof this)throw new TypeError("Array.prototype.reduce called on null or undefined");if("function"!=typeof a)throw new TypeError(a+" is not a function");var c,d,e=this.length>>>0,f=!1;for(1<arguments.length&&(d=b,f=!0),c=0;e>c;++c)this.hasOwnProperty(c)&&(f?d=a(d,this[c],c,this):(d=this[c],f=!0));if(!f)throw new TypeError("Reduce of empty array with no initial value");return d}),m.fn=a.prototype={clone:function(){return m(this)},format:function(a,b){return c(this,a?a:r,void 0!==b?b:Math.round)},unformat:function(a){return"[object Number]"===Object.prototype.toString.call(a)?a:d(this,a?a:r)},value:function(){return this._value},valueOf:function(){return this._value},set:function(a){return this._value=Number(a),this},add:function(a){function b(a,b){return a+c*b}var c=l.call(null,this._value,a);return this._value=[this._value,a].reduce(b,0)/c,this},subtract:function(a){function b(a,b){return a-c*b}var c=l.call(null,this._value,a);return this._value=[a].reduce(b,this._value*c)/c,this},multiply:function(a){function b(a,b){var c=l(a,b);return a*c*b*c/(c*c)}return this._value=[this._value,a].reduce(b,1),this},divide:function(a){function b(a,b){var c=l(a,b);return a*c/(b*c)}return this._value=[this._value,a].reduce(b),this},difference:function(a){return Math.abs(m(this._value).subtract(a).value())}},s&&(module.exports=m),"undefined"==typeof ender&&(this.numeral=m),"function"==typeof define&&define.amd&&define([],function(){return m})}).call(this);(function($,_){var StatsCard=function(el,options){this.init(el,options)};StatsCard.prototype={constructor:StatsCard,template:_.template($("#statscard-template").html()),init:function(el,options){this.$element=$(el);this.screenName=this.$element.data("screenname")?this.$element.data("screenname"):options.screenName;this.loginURL=options.loginURL;this.author=null;this.intentTimeout=null;this.options=$.extend({placement:"right",trigger:"manual",html:true});this.createPopover({content:Ibles.locale.uiElements.loading})},createPopover:function(options){this.$element.popover($.extend({},this.options,options)).hover($.proxy(this.mouseInTrigger,this),$.proxy(this.mouseOut,this))},getPopover:function(){return this.$element.data("popover")},getPopoverContainer:function(){return this.$element.data("popover").tip()},showPopover:function(){this.getPopover().show()},fetchAuthor:function(callback){if(!this.contentRequested){var apiParams={lite:"true",screenName:this.screenName};$.get("/json-api/showAuthor?"+$.param(apiParams),function(data){callback(data)});this.contentRequested=true}},getStatscardContent:function(){if(!this.signupDateFormated){this.author.signup=moment(this.author.signup.split(" ")[0]).format("MMM Do YYYY");this.signupDateFormated=true}if(!this.countsFormatted){var viewCount=this.author.views,favoritesCount=this.author.favoritesCount;this.author.views=numeral(viewCount).format("0,0");this.author.favoritesCount=numeral(favoritesCount).format("0,0");this.countsFormatted=true}return this.template({data:this.author})},mouseInTrigger:function(e){var that=this;this.hovering=true;this.intentTimeout=setTimeout(function(){if(that.hovering){that.getPopover().show();that.fetchAuthor(function(data){that.author=data;that.author.following=typeof data.following!=="undefined"&&data.following;that.getPopover().destroy();that.createPopover({content:$.proxy(that.getStatscardContent,that),template:$("#statscard-wrapper-template").html()});that.showPopover();that.getPopoverContainer().hover($.proxy(that.mouseInPopover,that),$.proxy(that.mouseOut,that));that.enableFollowing()})}},250)},mouseInPopover:function(e){this.hovering=true},mouseOut:function(e){this.hovering=false;var that=this;clearTimeout(this.intentTimeout);clearTimeout(this.persistenceTimeout);this.persistenceTimeout=setTimeout(function(){if(!that.hovering){that.$element.popover("hide")}},500)},enableFollowing:function(){var that=this;this.getPopoverContainer().on("click",".follow-btn",function(e){var followBtn=$(e.currentTarget);followBtn.addClass("disabled");followBtn.children("span").html(Ibles.locale.uiElements.loading);$.ajax({url:"/json-api/"+(that.author.following?"unfollowAuthor":"followAuthor"),dataType:"json",type:"POST",data:{screenName:that.screenName}}).done(function(data){var isFollowing=data.isFollowing;that.author.following=isFollowing;if(isFollowing){that.author.followersCount++}else{that.author.followersCount--}}).fail(function(jqXHR,textStatus){if(jqXHR.status===401)window.location.href=that.loginURL}).complete(function(){followBtn.removeClass("disabled");followBtn.fadeOut(400,function(){followBtn.children("span").html(that.author.following?followBtn.data("followingtxt"):followBtn.data("followtxt"));followBtn.children(".bg-icon").removeClass("checkmarksmall plus").addClass(that.author.following?"checkmarksmall":"plus");followBtn.fadeIn(400)});var countContainer=followBtn.closest(".follow").find(".callout"),followCount=that.author.followersCount;countContainer.text(followCount)})})}};$.fn.statscard=function(option){return this.each(function(){var $this=$(this),data=$this.data("statscard"),options=typeof option=="object"&&option;if(!data)$this.data("statscard",data=new StatsCard(this,options))})};$.fn.statscard.Constructor=StatsCard})(window.jQuery,window._);!function(a,b,c,d){var e=a(b);a.fn.lazyload=function(f){function g(){var b=0;i.each(function(){var c=a(this);if(!j.skip_invisible||c.is(":visible"))if(a.abovethetop(this,j)||a.leftofbegin(this,j));else if(a.belowthefold(this,j)||a.rightoffold(this,j)){if(++b>j.failure_limit)return!1}else c.trigger("appear"),b=0})}var h,i=this,j={threshold:0,failure_limit:0,event:"scroll",effect:"show",container:b,data_attribute:"original",skip_invisible:!0,appear:null,load:null,placeholder:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC"};return f&&(d!==f.failurelimit&&(f.failure_limit=f.failurelimit,delete f.failurelimit),d!==f.effectspeed&&(f.effect_speed=f.effectspeed,delete f.effectspeed),a.extend(j,f)),h=j.container===d||j.container===b?e:a(j.container),0===j.event.indexOf("scroll")&&h.bind(j.event,function(){return g()}),this.each(function(){var b=this,c=a(b);b.loaded=!1,(c.attr("src")===d||c.attr("src")===!1)&&c.is("img")&&c.attr("src",j.placeholder),c.one("appear",function(){if(!this.loaded){if(j.appear){var d=i.length;j.appear.call(b,d,j)}a("<img />").bind("load",function(){var d=c.attr("data-"+j.data_attribute);c.hide(),c.is("img")?c.attr("src",d):c.css("background-image","url('"+d+"')"),c[j.effect](j.effect_speed),b.loaded=!0;var e=a.grep(i,function(a){return!a.loaded});if(i=a(e),j.load){var f=i.length;j.load.call(b,f,j)}}).attr("src",c.attr("data-"+j.data_attribute))}}),0!==j.event.indexOf("scroll")&&c.bind(j.event,function(){b.loaded||c.trigger("appear")})}),e.bind("resize",function(){g()}),/(?:iphone|ipod|ipad).*os 5/gi.test(navigator.appVersion)&&e.bind("pageshow",function(b){b.originalEvent&&b.originalEvent.persisted&&i.each(function(){a(this).trigger("appear")})}),a(c).ready(function(){g()}),this},a.belowthefold=function(c,f){var g;return g=f.container===d||f.container===b?(b.innerHeight?b.innerHeight:e.height())+e.scrollTop():a(f.container).offset().top+a(f.container).height(),g<=a(c).offset().top-f.threshold},a.rightoffold=function(c,f){var g;return g=f.container===d||f.container===b?e.width()+e.scrollLeft():a(f.container).offset().left+a(f.container).width(),g<=a(c).offset().left-f.threshold},a.abovethetop=function(c,f){var g;return g=f.container===d||f.container===b?e.scrollTop():a(f.container).offset().top,g>=a(c).offset().top+f.threshold+a(c).height()},a.leftofbegin=function(c,f){var g;return g=f.container===d||f.container===b?e.scrollLeft():a(f.container).offset().left,g>=a(c).offset().left+f.threshold+a(c).width()},a.inviewport=function(b,c){return!(a.rightoffold(b,c)||a.leftofbegin(b,c)||a.belowthefold(b,c)||a.abovethetop(b,c))},a.extend(a.expr[":"],{"below-the-fold":function(b){return a.belowthefold(b,{threshold:0})},"above-the-top":function(b){return!a.belowthefold(b,{threshold:0})},"right-of-screen":function(b){return a.rightoffold(b,{threshold:0})},"left-of-screen":function(b){return!a.rightoffold(b,{threshold:0})},"in-viewport":function(b){return a.inviewport(b,{threshold:0})},"above-the-fold":function(b){return!a.belowthefold(b,{threshold:0})},"right-of-fold":function(b){return a.rightoffold(b,{threshold:0})},"left-of-fold":function(b){return!a.rightoffold(b,{threshold:0})}})}(jQuery,window,document);Ibles.package("Ibles.views","Ibles.models","Ibles.collections");Ibles.models.CandidateContest=Backbone.Model.extend({defaults:{id:null,title:null,url:null,urlString:null,thumbUrl:null,squareUrl:null,onlyUS:false,pending:false,entered:false},initialize:function(options){this.set({url:Ibles.reverseUrls.contestDetailUrl(this.get("urlString")),squareUrl:this.get("thumbUrl")&&this.get("thumbUrl").replace("THUMB","SQUARE2")})},enteredContest:function(){return this.get("entered")||this.get("pending")},enterOrLeaveContest:function(){var self=this,action=this.enteredContest()?"REMOVE":"ADD";Ibles.API.contestAjaxRequest("enter",{contestId:this.get("id"),instructableId:this.collection.ibleId,posted:(new Date).getTime(),action:action},{success:function(){if(self.enteredContest()){self.set({entered:false,pending:false})}else{self.set({entered:false,pending:true})}}})}});Ibles.collections.CandidateContests=Backbone.Collection.extend({model:Ibles.models.CandidateContest,initialize:function(models,options){this.ibleId=options.ibleId;this.iblePublishDate=options.iblePublishDate;this.enteredContests=options.enteredContests;this.loadContests()},loadContests:function(){var self=this;$.when(this.addPendingContests(),this.addOpenedContests()).done(function(){self.addEnteredContests();self.trigger("doneLoadingContests")})},addEnteredContests:function(){var enteredContests=_.map(this.enteredContests,function(contest){contest.entered=true;return contest});this.add(enteredContests,{at:0,merge:true})},addPendingContests:function(){var self=this;return Ibles.API.getRequest("showInstructableUserData",{id:this.ibleId},{success:function(data){var pendingInContests=_.map(data.pendingInContests,function(contest){contest.pending=true;return contest});self.add(pendingInContests,{merge:true})}})},addOpenedContests:function(){var self=this,publishDate=moment(this.iblePublishDate);return Ibles.API.getRequest("getContests",{},{success:function(data){var openContests=_.filter(data.contests,function(contest){var startDate=moment(contest.startDate),deadline=moment(contest.deadline);return contest.state==="open"&&startDate.isBefore(publishDate)&&deadline.isAfter(publishDate)});self.add(openContests,{merge:true})}})}});Ibles.views.CandidateContestView=Backbone.View.extend({template:_.template($("#eligible-contest-template").html()),tagName:"li",events:{"click .add-btn":"toggleEnterContest","click .us-only-checkbox":"toggleUsResident","hover .add-btn":"enterHover"},initialize:function(){this.listenTo(this.model,"change:entered change:pending",this.changeEnteredStatus)},changeEnteredStatus:function(){var $button=this.$(".add-btn");if(this.model.get("pending")){$button.button("pending")}else if(this.model.get("entered")){$button.button("added")}else{$button.button("add")}$button.attr("disabled",false)},toggleEnterContest:function(e){e.preventDefault();$(e.currentTarget).button("loading");this.model.enterOrLeaveContest()},toggleUsResident:function(e){var $button=this.$(".add-btn"),doDisable=typeof disable==="undefined"&&$button.hasClass("disable")||disable===true;if(doDisable){$button.attr("disable","disabled")}else{$button.attr("disabled",false)}},enterHover:function(e){var $button=$(e.currentTarget);if(this.model.enteredContest()){if(e.type==="mouseenter"){$button.button("remove")}else if(e.type==="mouseleave"){if(this.model.get("pending"))$button.button("pending");else $button.button("added")}}},render:function(){this.$el.html(this.template(this.model.toJSON()));return this}});Ibles.views.AddToContestView=Backbone.View.extend({id:"add-to-contest-modal",className:"add-to-modal modal hide fade",template:_.template($("#add-to-contest-modal-template").html()),initialize:function(options){var ibleData=options.ibleData;this.eligibleContests=new Ibles.collections.CandidateContests([],{ibleId:ibleData.id,iblePublishDate:ibleData.publishDate,enteredContests:ibleData.votableContests});this.listenTo(this.eligibleContests,"add",this.renderEligibleContest);this.listenToOnce(this.eligibleContests,"doneLoadingContests",this.renderContestList);$("body").append(this.$el);this.$el.html(this.template())},render:function(){this.$el.modal()},renderEligibleContest:function(contest){this.$(".eligible-contests").append(new Ibles.views.CandidateContestView({model:contest}).render().el)},renderContestList:function(){this.$(".loading").hide();if(this.eligibleContests.length>0){this.$(".eligible-contests").show()}else{this.$(".no-contests-msg").show()}}});Ibles.package("Ibles.views","Ibles.models");Ibles.models.CandidateGroup=Backbone.Model.extend({defaults:function(){return{id:null,title:null,path:null,url:null,addedDate:null,tinyUrl:null,smallUrl:null,groupCategories:[],categoryInGroup:"",added:false}},initialize:function(options){if(!_.isEmpty(this.get("groupId")))this.set("id",this.get("groupId"));if(!_.isEmpty(this.get("groupTitle")))this.set("title",this.get("groupTitle"));if(!_.isEmpty(this.get("path")))this.set("url",Ibles.reverseUrls.groupUrl(this.get("path")))},toggleAddToGroup:function(){var data={groupId:this.get("id"),groupCategory:this.get("categoryInGroup"),posted:(new Date).getTime()},self=this;data[this.get("added")?"removeId":"approveId"]=this.collection.ibleId;return $.ajax({url:"/group/addinstructable/",type:"POST",data:data,success:function(data){self.set({added:!self.get("added")})}})}});Ibles.collections.CandidateGroups=Backbone.Collection.extend({model:Ibles.models.CandidateGroup,initialize:function(models,options){this.ibleId=options.ibleId;this.groupsIbleBelongsTo=options.groupsIbleBelongsTo;this.loadGroups()},loadGroups:function(options){var self=this;$.when(this.addGroupsUserBelongsTo()).done(function(){self.addGroupsIbleBelongsTo();self.trigger("doneLoadingGroups")})},addGroupsIbleBelongsTo:function(){var self=this,groupsIbleBelongsTo=_.map(this.groupsIbleBelongsTo,function(group){self.normalizeGroupData(group);group.added=true;return group});groupsIbleBelongsTo=_.filter(groupsIbleBelongsTo,function(group){return!!self.get(group.id)});if(groupsIbleBelongsTo.length)this.add(groupsIbleBelongsTo,{merge:true})},addGroupsUserBelongsTo:function(){var self=this;return Ibles.API.getRequest("showAuthor",{},{success:function(data){if(data.groups&&data.groups.length){_.each(data.groups,self.normalizeGroupData);self.add(data.groups)}}})},normalizeGroupData:function(groupData){if(!_.isEmpty(groupData.groupId))groupData.id=groupData.groupId;if(!_.isEmpty(groupData.groupTitle))groupData.title=groupData.groupTitle;if(!_.isEmpty(groupData.path))groupData.url=Ibles.reverseUrls.groupUrl(groupData.path);return groupData}});Ibles.views.CandidateGroupView=Backbone.View.extend({template:_.template($("#eligible-group-template").html()),tagName:"li",events:{"click .add-btn":"toggleAddToGroup","change .group-categories-dropdown":"groupCategorySelected","hover .add-btn":"addHover"},initialize:function(){this.listenTo(this.model,"change:added",this.changeAddedStatus)},changeAddedStatus:function(){var $button=this.$(".add-btn");if(this.model.get("added")){$button.button("added")}else{$button.button("add")}$button.attr("disabled",false)},toggleAddToGroup:function(e){e.preventDefault();$(e.currentTarget).button("loading");this.model.toggleAddToGroup()},groupCategorySelected:function(e){this.model.set("categoryInGroup",$(e.currentTarget).val())},addHover:function(e){var $button=$(e.currentTarget);if(this.model.get("added")){if(e.type==="mouseenter"){$button.button("remove")}else if(e.type==="mouseleave"){$button.button("added")}}},render:function(){this.$el.html(this.template(this.model.toJSON()));return this}});Ibles.views.AddToGroupView=Backbone.View.extend({id:"add-to-group-modal",className:"add-to-modal modal hide fade",template:_.template($("#add-to-group-modal-template").html()),initialize:function(options){var ibleData=options.ibleData;this.eligibleGroups=new Ibles.collections.CandidateGroups([],{ibleId:ibleData.id,groupsIbleBelongsTo:ibleData.groupsBelongedTo});this.listenTo(this.eligibleGroups,"add",this.renderEligibleGroup);this.listenToOnce(this.eligibleGroups,"doneLoadingGroups",this.renderGroupList);$("body").append(this.$el);this.$el.html(this.template())},render:function(){this.$el.modal()},renderEligibleGroup:function(group){this.$(".eligible-groups").append(new Ibles.views.CandidateGroupView({model:group}).render().el)},renderGroupList:function(){this.$(".loading").hide();if(this.eligibleGroups.length>0){this.$(".eligible-groups").show()}else{this.$(".no-groups-msg").show()}}});